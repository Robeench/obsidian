https://www.frameip.com/routage/

## Introduction

Switch = fonctionne sur la couche 2 (liaison de données) et permet de transmettre des trames ethernet entre les périphériques d'un même réseau. 
Lorsque les adresses IP source et de destination se trouvent sur des réseaux différents, la trame ethernet doit être envoyée à un [[Routeur]].

[[Routeur]] = Il est responsable de la transmission de paquets à travers différents réseaux. Via sa table de routage, il détermine le meilleur chemin à utiliser pour transférer un paquet. 
Lorsqu'un hôte envoie un paquet à un périphérique situé sur un autre réseau, il est transmis à la passerelle par défaut, car un périphérique hôte ne peut pas communiquer directement avec les périphériques situés en dehors du réseau local. 
La passerelle par défaut est la destination qui route le trafic du réseau local vers des périphériques sur des réseaux distants. 

Pour activer l'accès au réseau, les périphériques doivent être configurés avec les informations permettant d'identifier les éléments suivants :
- Adresse IP : identifie un hôte unique sur un réseau local ;
- Masque de sous-réseau : identifie avec quel sous-réseau l'hôte peut communiquer ;
- Passerelle par défaut : identifie le [[Routeur]] auquel envoyer un paquet lorsque la destination n'est pas sur le même sous-réseau local.

La passerelle par défaut est généralement l'adresse de l'interface du [[Routeur]] connecté au réseau local. Le [[Routeur]] gère des entrées de table de routage pour tous les réseaux connectés ainsi que des entrées de réseaux distants et détermine le meilleur chemin pour atteindre ces destinations.

## Caractéristiques d'un réseau
### Indicateurs de structures et de performances
Ces caractéristiques et attributs permettent de comparer différentes solutions réseau.

#### Topologie
##### Topologie physique
La topologie physique correspond à la configuration des câbles, des périphériques réseau et des systèmes finaux. Elle indique comment les périphériques réseau sont interconnectés au moyen de fils et de câbles.

##### Topologie logique
La topologie logique est le chemin par lequel les données sont transmises dans un réseau. Elle décrit comment les périphériques réseau sont connectés aux utilisateurs du réseau.

#### Vitesse
La vitesse mesure le débit des données pour une liaison du réseau en bits par seconde (bits/s).

#### Coût
Le coût indique les dépenses générales consacrées à l'achat de composants réseau, ainsi qu'à l'installation et à la maintenance du réseau.

#### Sécurité
La sécurité correspond au niveau de protection du réseau, englobant les informations transmises sur le réseau. La sécurité est un thème important, sachant que les techniques et les pratiques concernées évoluent en permanence. 
Tenez en compte chaque fois que des mesures affectant le réseau sont prises.

#### Disponibilité
La disponibilité mesure la probabilité que le réseau soit disponible lorsqu'on en a besoin.

#### Evolutivité
L'évolutivité indique la facilité avec laquelle le réseau peut accueillir plus d'utilisateurs et répondre à davantage de demandes de transmission de données. Si la conception d'un réseau est optimisée pour répondre uniquement aux besoins actuels, il peut être très difficile et coûteux de s'adapter aux nouveaux besoins lorsque le réseau évolue.

#### Fiabilité
La fiabilité correspond à la capacité à fonctionner sans incidents des éléments constitutifs du réseau, notamment les routeurs, les switchs, les ordinateurs, et les serveurs. La fiabilité est souvent mesurée comme la probabilité de panne ou l'intervalle moyen entre les défaillances.

## Pourquoi le routage ?
La communication entre les réseaux serait impossible sans un [[Routeur]] pour déterminer le meilleur chemin vers la destination et transférer le trafic vers le prochain [[Routeur]] sur ce chemin. Le [[Routeur]] est responsable du routage du trafic entre les réseaux. 

Lorsqu'un paquet arrive sur une interface de [[Routeur]], le [[Routeur]] utilise sa table de routage pour déterminer comment atteindre le réseau de destination. La destination du paquet IP peut être un serveur Web se trouvant dans un autre pays ou un serveur de messagerie situé sur le réseau local. Les routeurs sont responsables de la transmission de ces paquets. L'efficacité des communications inter-réseaux dépend, en grande partie, de la capacité des routeurs à transférer des paquets de la manière la plus efficace possible.

## Mécanismes de transfert des paquets
Les routeurs prennent en charge trois mécanismes de transfert des paquets

### Commutation de processus
Ancien mécanisme de transfert de paquets toujours disponible pour les routeurs Cisco. 
Lorsqu'un paquet arrive sur une interface, il est transféré au plan de contrôle où le processeur fait correspondre l'adresse de destination avec une entrée de sa table de routage, puis détermine l'interface de sortie et transmet le paquet. 
Il est important de comprendre que le [[Routeur]] effectue cette opération pour chaque paquet, même si la destination est identique pour une série de paquets. Ce mécanisme de commutation de processus est très lent et rarement mis en œuvre dans les réseaux modernes. 

### Commutation rapide
Ce mécanisme de transfert de paquets courant utilise un cache à commutation rapide pour stocker les informations de tronçon suivant. 
Lorsqu'un paquet arrive sur une interface, il est transféré au plan de contrôle où le processeur recherche une correspondance dans le cache à commutation rapide. S'il ne trouve rien, le paquet est commuté par le processus et transféré à l'interface de sortie. Les informations de flux pour le paquet sont également stockées dans le cache à commutation rapide. 
Si un autre paquet ayant la même destination arrive sur une interface, les informations de tronçon suivant du cache sont réutilisées sans intervention du processeur. 

### CEF
= Cisco Express Forwarding
Le protocole CEF est le mécanisme de transfert de paquets Cisco IOS le plus récent et le plus prisé. Comme la commutation rapide, le protocole CEF génère une table FIB et une table de contiguïté. Cependant, à la différence de la commutation rapide, les entrées de table ne sont pas déclenchées par les paquets, mais par les modifications, comme en cas de changement dans la topologie du réseau. 
Par conséquent, lorsqu'un réseau a convergé, les tables FIB et de contiguïté contiennent toutes les informations qu'un [[Routeur]] doit prendre en compte lors du transfert d'un paquet. La table FIB contient les recherches inverses pré-informatisées, les informations de tronçon suivant pour les routes incluant l'interface et les informations de couche 2.
Le protocole CEF est le mécanisme de transfert le plus rapide et le choix privilégié pour les routeurs Cisco.

## Configuration des paramètres de base du [[Routeur]]

Les routeurs et les switchs Cisco ont beaucoup de points communs. Ils prennent en charge le même système d'exploitation de modes, les mêmes structures de commandes et comptent de nombreuses commandes similaires. 
En outre, les deux périphériques présentent des étapes de configuration initiale similaires.

### Configuration

1. Nommer le périphérique
```
hostname nom_[[routeur]]
```

2. Sécuriser l'accès à la gestion
Sécurise le mode d'exécution privilégié, le mode d'exécution utilisateur et l'accès Telnet, et chiffre les mots de passe à leur niveau le plus élevé.

3. Configurer une bannière
Rédige les mentions légales de tout accès non autorisé.
Enregistrez toujours les modifications sur un [[Routeur]] et vérifiez la configuration de base et le fonctionnement du [[Routeur]]. 

```
copy running-config startup-config show running-config
```

4. Configurer l'interface du [[Routeur]] IPv4
Les routeurs sont compatibles avec les LAN et WAN et peuvent interconnecter différents types de réseaux. Ils prennent donc en charge plusieurs types d'interfaces (LAN : Fast Ethernet, Giga Bit Ethernet - WAN : Serial)

``` shell
#Adressage en IPv4
interface fa0/1
ip address 192.168.X.X 255.255.255.0

#Activation de l'interface
interface fa0/1
no shutdown
```

5. Configurer une interface de bouclage IPv4
L’interface de bouclage est une interface logique interne au [[Routeur]]. Elle n'est pas affectée à un port physique et ne peut donc jamais être connectée à un autre périphérique. 

``` shell
interface loopback numéro (en général 0)
ip address 192.168.X.X 255.255.255.0
exit
```

Plusieurs interfaces de bouclage peuvent être activées sur un [[Routeur]]. L'adresse IPv4 de chaque interface de bouclage doit être unique et ne doit pas être utilisée par une autre interface.

## Fonction de commutation
C'est le processus utilisé par un [[Routeur]] pour recevoir un paquet sur une interface et l'envoyer vers une autre interface. Elle a pour responsabilité principale d'encapsuler les paquets dans le type de trame de liaison de données adéquat pour la liaison de données de sortie.
Lorsqu'il reçoit le paquet, le [[Routeur]] effectue les trois étapes principales suivantes :
- Il désencapsule le paquet de couche 3 en supprimant l'en-tête et le code de fin (trailer) de la trame de couche 2.
- Il examine l'adresse IP de destination du paquet IP pour trouver le meilleur chemin dans la table de routage.
- Si le [[Routeur]] trouve un chemin vers la destination, il encapsule le paquet de couche 3 dans une nouvelle trame de couche 2 et transfère la trame à l'interface de sortie.

## Décision de routage
Le [[Routeur]] doit déterminer le meilleur chemin à utiliser pour envoyer des paquets. Pour cela, il recherche dans sa table de routage une adresse réseau correspondant à l'adresse IP de destination du paquet.

La recherche de la table de routage détermine l'un des trois chemins suivants : 

### Réseau connecté directement
Si l'adresse IP de destination du paquet appartient à un périphérique situé sur un réseau qui est connecté directement à l'une des interfaces du [[Routeur]], le paquet est transféré directement au périphérique de destination. Cela signifie que l'adresse IP de destination du paquet est une adresse d'hôte sur le même réseau que l'interface de ce [[Routeur]].

### Réseau distant
Si l'adresse IP de destination du paquet appartient à un réseau distant, le paquet est transféré à un autre [[Routeur]]. Il n'est possible d'accéder aux réseaux distants qu'en transférant les paquets à un autre [[Routeur]].

### No route determined
Si l'adresse IP de destination du paquet n'appartient pas à un réseau connecté ou distant, le [[Routeur]] détermine s'il existe une passerelle de dernier recours disponible. 
Une passerelle de dernier recours est définie lorsqu'une route par défaut est configurée. S'il existe une route par défaut, le paquet est transmis à la passerelle de dernier recours. Si ce n'est pas le cas, le paquet est rejeté. Le [[Routeur]] envoie alors un message ICMP d'inaccessibilité à l'adresse IP source du paquet.

### Meilleur chemin
La détermination du meilleur chemin implique d'évaluer plusieurs chemins menant au même réseau de destination et de choisir le chemin optimal ou le plus court pour atteindre ce réseau. Lorsqu'il existe plusieurs chemins menant au même réseau, chaque chemin utilise une interface de sortie différente sur le [[Routeur]] pour atteindre ce réseau.
Le meilleur chemin est sélectionné par un protocole de routage, qui utilise une métrique pour déterminer la distance à parcourir pour atteindre un réseau.

métrique = evaleur quantitative utilisée pour mesurer la distance pour un réseau donné. Le meilleur chemin pour rejoindre un réseau est celui dont la métrique est la plus faible.

Voici quelques protocoles dynamiques et les métriques qu'ils utilisent :
- RIP (Routing Information Protocol) - nombre de sauts
- OSPF (Open Shortest Path First) - coût de Cisco basé sur la bande passante cumulée entre la source et la destination
- EIGRP (Enhanced Interior Gateway Routing Protocol) - bande passante, délai, charge, fiabilité

## Equilibrage de charge
Lorsqu'un [[Routeur]] contient deux chemins ou plus vers une destination avec des métriques à coût égal, le [[Routeur]] transmet les paquets en utilisant de manière égale les deux chemins. 
C'est l'équilibrage de charge à coût égal. 

La table de routage contient le réseau de destination unique, mais plusieurs interfaces de sortie, une pour chaque chemin de coût égal. Le [[Routeur]] transfère les paquets en utilisant les différentes interfaces de sortie répertoriées dans la table de routage. 

S'il est correctement configuré, l'équilibrage de charge peut améliorer l'efficacité et les performances du réseau. Il peut être configuré pour utiliser à la fois des protocoles de routage dynamique et des routes statiques.

### Distance administrative
Il est possible de configurer un [[Routeur]] avec plusieurs protocoles de routage et des routes statiques. Dans ce cas, la table de routage peut disposer de plusieurs sources de route pour le même réseau de destination. 
Par exemple, si les protocoles RIP et EIGRP sont tous deux configurés sur un [[Routeur]], les deux protocoles de routage peuvent détecter le même réseau de destination. Cependant, chaque protocole de routage peut décider d'un chemin différent vers la destination en fonction de ses métriques.
 
## La table de routage
C'est un fichier de données dans la mémoire vive qui sert à stocker des informations concernant la route pour les réseaux connectés directement et les réseaux distants. La table de routage contient des associations de réseau ou de tronçon suivant.
La table de routage d'un [[Routeur]] stocke différentes informations :

### Les routes connectées directement
Ces routes proviennent des interfaces actives du [[Routeur]]. Les routeurs ajoutent une route connectée directement lorsqu'une interface est configurée avec une adresse IP et est activée.

### Les routes distantes 
Ces routes correspondent aux réseaux distants connectés à d'autres routeurs. Les routes menant à ces réseaux peuvent être configurées de manière statique ou dynamique à l'aide de protocoles de routage dynamiques.

### Sources de la table de routage

``` shell
show ip-route #permet d'afficher la table de routage IPv4
```

Un [[Routeur]] fournit des informations supplémentaires concernant la route :
- la façon dont elle a été détectée, 
- depuis combien de temps elle se trouve dans la table,
- quelle interface spécifique permet d'atteindre une destination prédéfinie.

Les entrées de la table de routage peuvent être ajoutées de plusieurs manières.
#### Interfaces de route locale
Ajoutées lorsqu'elles sont configurées et actives. Cette entrée est uniquement affichée dans IOS 15 ou les versions plus récentes pour les routes IPv4 et dans toutes les versions IOS pour les routes IPv6.

#### Interfaces connectées directement 
Ajoutées à la table de routage lorsqu'elles sont configurées et actives.

#### Routes statiques 
Ajoutées lors de leur configuration manuelle et quand l'interface de sortie est active.

#### Protocole de routage dynamique 
Ajouté lorsque des protocoles de routage qui découvrent le réseau de manière dynamique, tels qu'EIGRP ou OSPF, sont mis en œuvre et que des réseaux sont identifiés.

La source des entrées de la table de routage est identifiée par un code. Il définit comment la route a été découverte. 
Voici quelques exemples de codes courants :
- L : identifie l'adresse attribuée à l'interface d'un [[Routeur]]. Ceci permet au [[Routeur]] de déterminer efficacement s'il reçoit un paquet destiné à l'interface et non à être transféré.
- C : signale un réseau connecté directement.
- S : identifie une route statique créée pour atteindre un réseau donné.
- D : identifie un réseau découvert de manière dynamique depuis un autre [[Routeur]] à l'aide du protocole EIGRP.
- O : identifie un réseau découvert de manière dynamique depuis un autre [[Routeur]] à l'aide du protocole de routage OSPF.

## Entrées de routage d'un réseau distant (P294)
Les routes statiques sont configurées manuellement. Elles définissent un chemin explicite entre deux périphériques réseau. 
Contrairement à un protocole de routage dynamique, les routes statiques ne sont pas automatiquement mises à jour : elles doivent être manuellement reconfigurées si la topologie du réseau est modifiée. L'utilisation de routes statiques permet notamment d'améliorer la sécurité et l'efficacité des ressources.

Il existe deux types courants de routes statiques dans la table de routage :

### Route statique vers un réseau donné 
Pour que la communication fonctionne de bout en bout, il faut configurer la route statique dans les deux sens. Cela peut être une route statique vers un réseau donné, ou une route statique par défaut.

``` shell
ip route network mask {next-hop-ip | exit-intf}

#route statique 
ip route 192.168.1.0 255.255.255.0 {exit-intf | next-hop-ip}
   #via le prochain saut
   ip route 192.168.1.0 255.255.255.0 172.16.1.2
   #via l'interface de sortie
	ip route 192.168.1.0 255.255.255.0 s0/1/0
#exemple avec l'interface de sortie
```

Une route statique par défaut est comparable à une passerelle par défaut sur un hôte. La route statique par défaut indique le point de sortie à utiliser lorsque la table de routage ne contient pas de chemin vers le réseau de destination. Une route statique par défaut est utile lorsqu'un [[Routeur]] ne dispose que d'un seul point de sortie vers un autre [[Routeur]].

``` shell
#Route statique par défaut
ip route 0.0.0.0 0.0.0.0 {exit-intf | next-hop-ip}
   #via le prochain saut
   ip route 0.0.0.0 0.0.0.0 172.16.1.1
   #via l'interface de sortie
   ip route 192.168.1.0 255.255.255.0 s0/1/1
```


## Routage dynamique

Les protocoles de routage dynamique sont utilisés par les routeurs pour partager des informations sur l'accessibilité et l'état des réseaux distants. 
Ils effectuent plusieurs tâches, notamment la détection de réseaux et la gestion des tables de routage.

### La détection de réseaux
La détection de réseaux est la capacité d'un protocole de routage à partager des informations concernant les réseaux qu'il connaît avec d'autres routeurs utilisant le même protocole de routage.

Au lieu de configurer manuellement des routes statiques vers des réseaux distants sur chaque [[Routeur]], un protocole de routage dynamique permet aux routeurs de recevoir automatiquement, par le biais d'autres routeurs, les informations nécessaires concernant ces réseaux. 

Ces réseaux, ainsi que le meilleur chemin vers chacun d'eux, sont ajoutés à la table de routage du [[Routeur]] et identifiés comme des réseaux détectés par un protocole de routage dynamique spécifique.
Lors de la découverte du réseau, les routeurs échangent des routes et mettent à jour leurs tables de routage. Les routeurs gèrent alors les réseaux dans leurs tables de routage.

### Protocoles de routage IPv4
Un [[Routeur]] exécutant un protocole de routage dynamique ne fournit pas seulement le meilleur chemin vers un réseau, il détermine également un autre meilleur chemin si le chemin initial devient inutilisable (ou si la topologie change). 
C'est pour cette raison que les protocoles de routage dynamique sont plus avantageux que les routes statiques. 

Les routeurs utilisant des protocoles de routage dynamique partagent automatiquement des informations de routage avec d'autres routeurs et prennent en compte toute modification de la topologie, sans nécessiter l'intervention de l'administrateur réseau.

Les routeurs Cisco ISR peuvent prendre en charge divers protocoles de routage IPv4 dynamiques, notamment :
- EIGRP (Enhanced Interior Gateway Routing Protocol)
- OSPF (Open Shortest Path First)
- RIP (Routing Information Protocol)

## Routage inter-VLAN 
L'utilisation des VLAN pour segmenter un réseau commuté permet d'améliorer les performances, la facilité de gestion et la sécurité. 
Les trunks servent à faire circuler des informations entre les périphériques depuis des VLAN multiples. Cependant, étant donné que ces VLAN ont segmenté le réseau, un processus de couche 3 est requis pour permettre au trafic de se déplacer d'un segment du réseau à un autre.

### Qu'est ce que le routage inter-VLAN ?
Les VLANs permettent de segmenter les réseaux commutés. 
Les switchs de couche 2 peuvent être configurés par un professionnel des réseaux avec plus de 4000 VLANs. Cependant, les commutateurs de couche 2 ont des fonctionnalités IPv4 et IPv6 très limitées et ne peuvent pas exécuter la fonction de routage des routeurs. 

VLAN = domaine de diffusion. Les ordinateurs se trouvant sur des VLAN différents ne peuvent donc pas communiquer sans l'intervention d'un dispositif de routage. Un périphérique qui prend en charge le routage de couche 3, tel qu'un [[Routeur]] ou un switch multicouche, permet d'exécuter les fonctions de routage nécessaires. 
Quel que soit le périphérique utilisé, le processus de transfert du trafic réseau d'un VLAN à un autre à l'aide du routage est appelé routage inter-VLAN.

### Routage inter-VLAN existant
La première solution de routage inter-VLAN reposait sur des routeurs dotés de plusieurs interfaces physiques. Chaque interface devait être connectée à un réseau distinct et configurée pour un sous-réseau différent.
Selon cette approche, le routage inter-VLAN s'effectue par la connexion de différentes interfaces de [[Routeur]] physiques à différents ports de switch physiques. 
Les ports de switchs connectés au [[Routeur]] sont placés en mode d'accès et chaque interface physique est affectée à un VLAN distinct. 
Chaque interface de [[Routeur]] peut alors accepter le trafic du VLAN associé à l'interface de switch à laquelle elle est connectée, et le trafic peut être acheminé vers les autres VLAN connectés aux autres interfaces.

