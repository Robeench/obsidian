David, Cristian, Béryl, Bénédicte

# Consignes
- [x] Installer et configurer le Synology
	- [x] Nom : nas01
	- [x] Alias : nas01.tssr.local
	- [x] @IP : 192.168.1.20
- [x] Créer un volume et les LUNs iSCSI
	- [x] Avec le SAN Manager
	- [x] Configurer le target iSCSI
	- [x] Créer deux LUNs de 200Go nommées LUN01 et LUN02
- [x] Configurer les initiateurs iSCSI sur les ESXi
	- [x] Créer un vswitch avec vmnic1
	- [x] Créer un vmkernel sans activité de service vmware
	- [x] Configurer les IPs iSCSI pour chaque ESXi
	- [x] esx01-iscsi : 192.168.1.21
	- [x] esx02-iscsi : 192.168.1.22
	- [x] Déclarer l'IP du Synology dans la conf iSCSI des ESXi
	- [x] Déclarer les IPs iSCSI des ESXi dans le SAN Manager iSCSI du Synology et autoriser les LUNs
- [x] Vérifier que les LUN sont bien montés sur les ESXi
	- [x] Faire un rescan vmhba
	- [x] Formater les LUN en VMFS6 et les nommés LUN01-DS01 et LUN01-DS02
- [x] Effectuer un storage vMotion des VMs sur le datastore
- [ ] Test vSphere HA
	- [ ] Faire un ping -t de DC02
	- [ ] Effectuer un débranchement électrique de l'ESXi qui porte DC02
	- [ ] Mesurer le temps de la perte de ping et du retour
- [ ] Faire un P2V de DC01 sur le cluster vSphere avec VMware Converter
	- [ ] Tester l'accès à la VM
- [ ] Faire évoluer le schéma réseau

# Installation
## NAS01
192.168.1.20

![[Pasted image 20230405170153.png]]

### Création Target01
![[Pasted image 20230405171426.png]]

### Création LUN01 et LUN02
![[Pasted image 20230405171228.png]]

## Initiateurs iSCI
[Adding LUN space to ESXi](https://www.youtube.com/watch?v=4eTjCbE5Xss)
[Adding iSCSI into VMWare](https://www.youtube.com/watch?v=N-KV8wv_Q1w)

![[Pasted image 20230405171447.png]]

### vSwitch
![[Pasted image 20230405172543.png]]
Connecter l'adaptateur physique
> Modifier les paramètres
	Définir l'adresse IPv4 statique, soit 192.168.1.21 pour l'ESXi01 et 192.168.1.22 pour l'ESXi02
![[Pasted image 20230406101442.png]]

Stockage > Adaptateur de stockage > vmhba64 > Liaison de port réseau > Ajouter
	vmkernel vswitch1
![[Pasted image 20230406101431.png]]

#### Configurer les IP
![[Pasted image 20230406095053.png]]

SAN Manager > Hôte > Ajouter un hôte
	Rentrer la configuration adaptée à l'ESXi concerné
![[Pasted image 20230406095728.png]]

Ajouter un adaptateur de stockage
	> ajout iSCSI
	> IP NAS

Puis dans le NAS
	création de l'hôte

Création de l'adaptateur avec la découverte dynamique
Création liaison de ports ESXi avec les adresses IP concernés
Brancher l'interface vmnic1 concerné

création du vswitch
branchement de la carte réseau concerné
puis vmk1
modifier les paramètres IPv4

## Vérification montage LUN
Réanalyser le stockage sous ESXi01 et ESXi02 : https://kb.vmware.com/s/article/1003988

[Comment configurer des LUN en tant que datastore d'un serveur VMWare](https://kb.synology.com/fr-fr/DSM/tutorial/How_to_set_up_Synology_NAS_as_VMware_server_datastore)

ISCSI > modifier > avancé

Vérifier la configuration côté NAS
Création d'un volume 1 avec les deux disques durs
SAN Manager
	création des 2 LUN

Côté ESXI
créer les deux vswitchs sur chaque esxi
adaptateur vmkernel
	vmk0 = .21
	vmk1 = .22
créer l'adaptateur escisi
liaison de port réseau : ajout vmk1
ajouter l'ip du synology (.20) dans la découverte dynamique

puis réanalyser le stockage
dans périphérique, on va voir les deux iscsi monter

Ensuite, création de 2 datastore avec ces LUN :
nouveau stockage > vmfs > lun02 > vmfs6 > utiliser tout l'espace disponible

Si ça ne remonte pas dans l'esxi2
SAN manager > iscsi > target > modifier > avancé > autoriser plusieurs sessions ...
![[Pasted image 20230406110245.png]]
Cela permettra que les LUN remontent aussi au sein de l'esxi2
Lancer un nouveau scan sur l'esxi2
Il n'est pas nécessaire de reformater les LUN sur chaque esxi, une fois que ça a été fait sur l'un, la configuration est automatique sur les autres. 

## Migration du stockage des VMs
[Migrate a virtual machine to new storage](https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.vcenterhost.doc/GUID-A15EE2F6-AAF5-40DC-98B7-0DF72E166888.html)
Il est conseillé d'effectuer les migrations à égalité sur le LUN01 et le LUN02 pour permettre une meilleure disponibilité du stockage. 
