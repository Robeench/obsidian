Rôle principal dans une entreprise qui permet la sécurité de l'authentification utilisateur. C'est le noyau d'une infrastructure système. Il permet de mettre en place le SSO. 
On y retrouve : 
- compte utilisateur
- mot de passe
- groupes
- serveurs

## DNS interne et externe
Il existe 2 DNS interne et externe. 

|DNS externe | DNS interne, lié à l'AD|
|:-:|:-:|
|FAI > pool IP publique + ligne internet|Onglet redirecteur : 2 IP publique de DNS externes
| NAT IP internet vers IP publique |
|(**2**) Fournisseur nom de domaine > DNS public + zone DNS exterieure|
| Mep lien DNS publique sur IP publique|mep lien vers IP privées/internes sur enregistrements et noms
| A (nom>ip), TXT, MX (*mail*), PTR (*reverse A ; pas de pointeurs dans un server DNS publique*), NS (*server DNS*), SOA (e*nr principal dns*), CNAME (*autre nom*)|Idem : A, TXT, MX, PTR, NS, SOA, CNAME
| Zone DNS ext = on fait pointer IP publique vers ex. ```intranet.tssr.net```|IP privée ( (**a**) ```192.168.20.240 srv.web)``` > ```.lan``` (```srv.web.lan```) en record A, (**b**) CNAME > vers le ```.lan``` (```intranet serv.web.lan```) OU (**c**) enregistrement zone A directement ```icp.fr > intranet.icp.fr``` comme ça que ce soit en interne/externe accès au server avec la même nomenclature)

Les enregistrements sont les mêmes pour les zones DNS internes et externes.

# Consignes
- [ ] Monter une AD unique
- [ ] Création de comptes, groupes, mdp, OU
- [ ] Mise en place des bonnes pratiques de l'AD
- [ ] Mise en place de GPO
- [ ] Sécurité NTFS (sécurité sur les dossiers et les fichiers)

- [ ] serveur debian
- [ ] version de windows server 2019
- [ ] iso windows 10 entreprise
- [ ] installer dans un réseau en NAT, avec un sous réseau
- [ ] 

# Installation

## Informations de base
Domain name = nitou.lan

- 8 CPU
- 10 Go RAM minimum
- 

## CLI-WIN10-01
- 2Go de RAM
- 1 CPU
- 50Go de SSD

## SRV_WIN2019_01
- 4Go de RAM

## SRV_DEB_02
- PF Sense
- 


# ACTIVE DIRECTORY 

*AD = LDAP (LDAPs = fonction sécurisé) = Annuaire = Annuaire d'identité*
Port AD 389 / Port LDAS 636   

![*](https://www.tranquil.it/wp-content/uploads/schema_ad-3.png)

AD => c'est une forêt => la forêt c'est le schéma qui est rempli d'attribut
Dnas cette forêt, il peut y avoir des domaines, voir des sous-domaines des domaines.   
En entreprise, pour éviter de complexifier son AD, on ne fait qu'un domaine, voir deux sous-domaines (messagerie et compte). On peut même simuler des sous-domaines pour ne pas complexifier l'AD. Grâce à cela on n'as qu'un seul et unique domaine à gérer.    
Le login côté AD s'apelle l'UPN (équivalent de l'adresse mail)
AD permet de gérer: les comptes génériques, les mdp, les groupes de sécurité, listes de diffusion, machines, serveur, GPO, BALS (implicitement c'est un compte / BALS: Boite aux lettres) générique, BALS équipements, BALS Salle.  

![](https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS-OCq2R8laBtW6mDouVe1vXllxMTu2jQcSkbhDhEJE20WWA8HeU0BZaoO8QMWnwmD0dTM&usqp=CAU)

Les 5 étapes de l'installtion d'un magnifique serveur neuf:  
- Configurer un RAID  
- Installation Windows Server  
- Configuration carte réseau (no DHCP, tout est fixé)  
- Faire les MàJ Microsoft  
- Antivirus   

**SERVER AD sont les CONTROLEURS DE DOMAINES**  
Ils sont aussi serveurs DNS externes. 
Les bonnes pratiques:
- C'est deux serveurs par site. Un contrôleur de domaine ne doit rien faire d'autres.  
- Ils doivent être physique. A la limite, un des deux peut être virtualisé.(par exemple, sur une infra VMWare qui crash et que les deux serveur sont virtualisé, c'est la misère)  
- Le principal doit rester en physique. Il héberge les rôle FSMO.
- La réplication AD permet de se synchroniser dans les 15 minutes entre tout les contrôleurs de domaine.  

Dans le cas d'un multi site:

|Paris| |Marseille| |Lyon| |Clermont|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|DC Prinicpal / DC Secondaire| --> VPN IPSEC SITE A SITE --> |DC Secondaire / DC Secondaire| --> VPN IPSEC SITE A SITE --> |DC Secondaire / DC Secondaire| --> VPN IPSEC SITE A SITE --> |DC Secondaire / DC Secondaire|
||Replication AD dans le tunnel||Replication AD dans le tunnel||Replication AD dans le tunnel|
||Ad src 172.16.0.0/24 vers ad dest 172.30.0.0/24||Ad src 172.30.0.0/24 vers dest 172.62.0.0/24||Ad src 172.62.0.0 vers ad dest 172.16.0.0/24|

*Bonne pratique:  
Les 4 sites sont relié en VPN IPSEC site à site 
Sur de l'intersite, faire passer de la réplication AD dans le tunel  
Tout les Firewalls propose le VPN IPSEC site à site. Les configurer exterieurements (sur Paris, mettre l'Ip publique de Marseille, ainsi que les méthodes d'encryption. Il faut qu'elle soit égale des 2 côtés. Idem pour la clé secret partagée).
Mettre la même marque de firewall sur tout ces sites*

# AD SUR WINDOWS SERVEUR 2019

### Construire un contrôleur de domaine principal.

- Gérer "Ajout de rôles et des fonctionnalités"
- Assisstant AJout de rôles:
  - Rôles de serveurs
  - Cocher Service AD DS (Gestion de Stratégie de Groupe déjà coché)
  - Lancer l'installation du rôle
- Drapeau Orange en haut à droite "Promouvoir se serveur en contrôleur de domaine"
- Assistant de Configuration des services de domaines AD
  - Configuration de déploiement
    - "Ajouter une nouvelle forêt"
    - Nom de domaine racine "om.lan"
  - Options du contrôleur de domaine
    - Serveur DNS: laissé coché
    - Catalogue Global (rôle de base)
    - Mot de passe: dadfba16$
  - Options supplémentaires
    - il le déduit seul "OM"
  - Chemin d'accès
    - On retrouve le chemin de l'enregistrement de la BDD.
    - *Bonne Pratique: sauvegardé les logs sur une partition D*
  - Lancer l'installation

L'AD se crée. Cela créee le schéma, la forêt, les FSMO.  
Sur un contrôleur de domaine, lorsque le domaine est crée, la notion d'Admi local, c'est terminé. On rentre obligatoirement en ADMINISTRATEUR DU DOMAINE.  

**Vérification et première configuration**  
- La première chose à faire c'est de modifier la DNS de la carte réseau du serveur. On met l'adresse Ip de lui-même car à partir de maintenant il est aussi serveur DNS.  
- **Outils Administration**, **Utilisateur et ordinateurs Active Directory**.
  - On verifie .... et catalogue global.
  - Clique-droit, Maitre d'opération
    - On a les 3 rôles FSMO
- **Outils Administration**, **DNS**.  
  - On vérifie que notre domaine est crée en zone directe.
  - Notre zone reverse n'est pas crée, il faut la crée.
    - clique-droit, ajouter une nouvelle zone.  
    - Ajouter le pointeur PTR du Record A de zone direct.  
  - Clique-droit, Propriété sur le serveur DNS
    - Ajouter nos DNS de FAI dans l'onglet Redirecteurs
  - ***Cela permet à l'exterieur (l'internet) de pointer vers le serveur interne.***
- **Outils Administration**, **Sites et services Active Directory**
  - Default-First-Site-Name
    - C'est le site sur lequel vous avez mis le controleur de domaine principal.  
    - On retrouve les contrôleurs de domaine rataché à ce site.  
  - Inter-Site-Transports
    - IP => DEFAULTIPSITELINK : C'est le moteur de réplication entre les contrôleurs de domaine. 
      - Clique-droit, Propriété et mettre la réplication à 15 min.  
  - Subnets (Le plus important! Il faut déclaré le réseau du site et le rataché au site.)
    - Clique-droit, Nouveau sous-réseau
      - Préfixe: 192.168.20.0/24 et séléctionné le site
  - Clique-droit sur Sites, Ajouter un nouveau site. (Par exemple Marseille). Penser à créer le subnet du réseau de Marseille.  
- **Outils Administration**, **Domaine et Approbation Active Directory**
  - Clique-droit, Propriété sur le Domaine et approbation AD.
    - On peut simuler des créations de sous-domaines ou des domaines.  
    - ***Si on ajoute un nouvel utilisateur, on peut lui crée son identifiant avec la partie mail que l'on veut.***  
- **Outils Administration**,  **Modèles ADSI**
  - Ici on a la retranscritpion de notre AD coté Forêt (CN = attribut)
  - C'est le coeur de l'AD


***ATTENTION***
| DNS | Suffixes UPN |
|:-:|:-:|
| bobdy.lan | bobdy.com / bobdy.fr |
| zone directe: bobdy.com ou bobdy.fr | cela peut être les mêmes |
| SERVEUR | MESSAGERIE/IDENTIFIANT |
| Dans la DNS interne (voir externe) | Dans l'Active Directory |

### Préparer le contrôleur de domaine secondaire

- 1ère chose: mettre l'IP du contrôleur principal dans les paramêtres de cartes réseau.  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/ping_repond.png?raw=true)
- 2nd chose: ajouter le domaine (On arrive dans les "computers" sur le controleur principal)  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/ajout_domaine.png?raw=true)
- Enfin se connecter en tant qu'administrateur du serveur (dans notre cas, login: OM\Administrateur)
- Désactivé le parefeu qui vient se rajouter suite à la rentrer dans le domaine.

*On clique sur le drapeau orange et on lance "promouvoir au controleur de domaine:*
- Ajout contrôleur de domaine au domaine existant
- Verifier qu'on est sur le bon domaine (om.lan)
- Vérifier qu'on est bien sur le site de "Paris" et choisir le bon serveur à répliquer.
- Rentrer le mdp de restauration.
- Verifier que tout est au vert, puis lancer l'installation.  

*Une fois installé, voilà quelques checks et réglages à faire:*
- Carte Réseau: Vérifier les paramêtres de carte. Mettre en DNS primaire nous (192.168.20.51) et en DNS secondaire celle du contrôleu principale (192.168.20.201).
- Vérifier dans l'AD, que tout les domaines controlleurs secondaires sont bien présent.  
- DNS: Vérifier qu'on a bien récupere om.lan; om.fr et la zone reverse. Supprimer les records inutiles.
- Créer un alias ldapjbf qui pointe sur notre serveur secondaire sur om.lan
- Créer un host A ldapjbf qui pointe sur notre serveur secondaire sur om.fr
- Allez dans Domaines et Approbation AD et vérifier qu'on a bien récuperé les suffixes de noms de domaine.  
- Allez dans Sites et services AD SItes/Paris/Servers, on doit tous y être. Si on dévellope notre serveur, on doit avoir notre *NTDS Settings* et enfin à droite on retrouve nos partenaire de réplications.  

Utilisateurs et ordinateurs AD  
- Builtin : on s'en sert assez peu au quotidien
- Computer : OU d'arrivée des PC et des servers dans l'AD
- Domain Controller : AD secondaire
- Users : Compte admin + autres comptes par défaut (structures d'OU/sous-OU)
  - Administrateur du domaine = niveau le plus bas (accès domaine pour l'usage quotidien)
  - Administrateur du schéma = possibilité de modifier le schéma (op d'expertise et de migration)
  - Administrateur de l'entreprise = total accès à toute la structure de l'AD

### Comment se structure une AD

Une arborescence AD, ses OU et ses sous-OU, dépend de l'entreprise dans laquelle on se trouve.

**Un exemple d'organistaion (les bonnes pratiques):**
- Côté machine:
  - Création OU Serveurs (donc tous serveurs qui arrive dans computers doit être déplacé dans cette OU)
  - Création OU Machines
    - Création sous-OU: Fixes
    - Création sous-OU: Portables
  - Création OU SallesInformatiques (y mettre les pcs de cette salle)
- Création OU BALS Générique pour ne pas mélanger les boites aux lettres avec les comptes génériques.
- 
On peut décliner par types de machines, au niveau des utilisateurs.  
Exemple: 
| OU global | COMPTESOFFICE365 | GOUPES
|:-:|:-:|:-:|
|sous-OU| Administratifs | Sécutité (on peut créer 2 sous OU ex: Appli / Data) |
|sous-OU| Enseignants | Liste de Diffusion |
|sous-OU| Vacataires |
|sous-OU| Exterieurs |

*Ne pas mettre d'espace ou de caractères spéciaux dans les noms d'OU*

### ON VA MANIPER

Créer une OU principale par personne pour éviter les conflits(Delegue).

|Créer des sous-OU:| |
|:-:|:-:|
| ComptesUtilisateurs / Groupes / Dans la sous-OU Groupes, créer deux sous-OU / Securite /ListesDiffusions|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/sousOU.png?raw=true)|

|Créer nos trois premiers utilisateurs.| |
|:-:|:-:|
| Mettre le nom en majuscule et le mettre avant le prénom | ![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/ajout_user.png?raw=true)|

Clique-droit Propriétés sur l'user:
  - Mettre le plus de renseignement possibles pour avoir quelque chose de complet, fortement apprécier des users.  
 
| Créer un groupe de sécurité | |
|:-:|:-:|
| Créer un groupe DSI et un groupe ServiceIT. Mettre ServiceIT dépendant du groupe DSI | ![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/groupes.png?raw=true)|
| Ajouter l'utilisateur dans le groupe ServiceIT | ![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/petit_groupe.png?raw=true)


*AzureAD vas aspirer le compte d'Arthur PENDRAGON et le synchroniser avant sa boite mail*

# GPO ET TRANSFERTS DE FICHIER

![](https://www.active-directory.info/wp-content/uploads/2016/03/annuaire-Active-Directory.jpg)

*Tout ce dont on parle n'est valable que si l'entreprise n'a pa Teams ou Sharepoint*

**PC Portables ou Fixes**  

- Besoin du personnel:
  - Environnement de Bureau
  - Données pures: 
    - Personnel
    - partagés ou communes ou `collectives
  - Images / Photos
  - Favoris Internet(Edge)
*Tout doit être sur le réseau ! Rien en dur sur le disque du PC*  

Côté GPO
- Attention : pour les entreprises passant par TEAMS ou SHAREPOINTS pas besoin de GPO car centralisé via les logiciels
- Attention : les données doivent être mis sur des servers de fichiers donc sur le reseau via GPO
    - GPO = du bureau (va prendre le bureau.local et le transposer sur le server de fichier/réseau etc.)
    - Need gros servers de fichiers (baie de stockage) = disques VM pointés vers baie de stockage 
    - VM branchées sur baies en ESX (derrière le cluster ESX il n'y a que des baies de stockage) = baie connectée aux ESX
        - Avenir = hypercoinvergence (on s'affranchit des baies) = VMWare sait embarquer le stockage dans son noyau, stockage embarqué dans les clusters VSAN qui deviennent aussi baie (baie de stockahe imbriquée à VMWare, disques en full flash)
- Attention : les GPO ne proposent pas la rediurection des ressources partagées
    - (1) need script powersheel pour reconnecter le lecteur reseeau (script de connexion dans une GPO)
    - (2) vous connectez sur le compte de l'user directement le ecteur reseau des partages collectifs avec l'onglet 

**Côté serveur de fichiers**  

Grosse bête pointe vers une baie de stockage. Elle projète des volumes directement sur le serveur. Et le serveur dans l'explorateur Windows vas présenter la baie.

Sur le server de fichier: Arborescence dossiers
D: Dossiers Ultisateurs --> partagé --> Sécurité NTFS
  - Dossier individuel des utilisateurs --> Pas de partage --> Sécurité NTFS
  - Le dossier pour qu'il redescende en GPO doit s'appeller avec le SAM (S. Acompte Mail.) --> %UserName%
  - Partages --> partagé --> Sécurité NTFS

**Première GPO**  

Toujours faire ses GPO sur la dernières sous-OU.  
Oultis / Gestion des stratégies de Groupes.  

|Creer une GPO|
|:-:|
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/gpo_creer.png?raw=true)  

Clique-droit / Propriétés sur la GPO qui vient d'être créer.

|Script Powershell| |
|:-:|:-:|
| Mettre le script dans le dossier (en bas l'image), puis le chargé dans le gestionnaire. |![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/scriptshell_gpo.png?raw=true)|  

Création de notre arborescence de fichier sur le lecteur C:
- C:\Partages\DSI\Service_IT

## Sur le dossier parent DossiersUtilisateurs

Clique-droit sur le dossier Partages/Propriétés/Partage avancé pui cocher "Partager ce dossier"
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/partage_gpo.png?raw=true)  
*Ne pas oublier l'autorisation partage sinon pas de partage*
  
Clique-droit sur le dossier Partages/Propriétés/Sécurité puis coché "Partager ce dossier"
Cliquez sur "Convertir [...] sur cet objet" 

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/h%C3%A9ritage_gpo.png?raw=true)

Le truc qu'il faut mettre partout pour ne pas avoir d'emmerde
- Système: Accès machine, **INDISPENSABLE**.
- Admins du domaine (OM\Admins du domaine)
- Utilisateurs Authentifier.
- On fait ajouter/Admin, chercher par nom et on trouve "admins du domaine".

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/gpo_secu_2.jpg?raw=true)

- Ajouter/Avancée/recherche/Utilisateurs authentifiés/Et affichage

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/user_auth_gpo.png?raw=true)

## Sur le dossier enfant DSI

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/dsi_gpo_secu$.png?raw=true)

Ne pas laisser le ***CONTROLE TOTAL*** pour les utilisateurs car cela leur donne accès à l'onglet de sécurité ce qui est une faille de sécuité énorme.

## Faire la même procédure pour le dossier enfant Service_IT.

On vas s'occuper de l'arborescence des dossiers utisateurs.
- On crée le dossier à la racine du disque:
  - C:\DossiersUtilisateurs
- On applique le partage sur ce dossier (comme vu précedemment).
- Sécurité:
  - On désactive l'héritage (comme vu précédemment).
  - On active la sécurité système, administrateur du domaine et utilisateurs authentifiers.
- Dans le dossier parent, on crée un dossier enfant avec un le SAM de l'utilisateur (apendragon).  
  - On gère la sécurité(comme vu précedemment) mais on enlève l'utilisateur authentifier et mettre l'user à la place, avec les rêgles qui vont bien.

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/secu_user_gpo.png?raw=true)

## Quota
Sur C: Clique-droit/propriétés/onglet Quota: 
- Cocher Activer la gestion
-  Refuser de l'espace disque ...   

Si on rend pas l'utilisateur propriétaire de son dossier, il n'auras pas son quota.
Pour faire de l'individuel, il faut clique-droit sur l'user pour gérer son espace disque.

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/quota_gpo$.png?raw=true)

Clique-droit sur le dossier/Propriétés/Sécurité/Avancé/Modifier/Choisir l'utilisateur.  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/proprio_dossier_user.png?raw=true)

## Dossiers des utilisateurs

Ouvrir l'éditeur de Gestion des stratégies de groupes 
Bureau: 
- Clique-droit/propriétés/Cible  
  - Paramêtres: *De base*
  - Rentrer le chemain d'accès à la racine \\WS19\DossiersUtilisateurs

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/proprio_bureau_gpo.png?raw=true)

- Clique-droit/propriétés/Paramètres
  - Décoché *Accorder à l'utilisateus des droits exclusifs sur Bureau* (sinon les admins ne peuvent plus y accèder pour régler des problèmes)  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/proprio_bureau_gpo2.png?raw=true)

Favoris:
- Clique-droit/propriétés/Cible  
  - Paramêtres: *De base*
  - Rentrer le chemain d'accès à la racine \\WS19\DossiersUtilisateurs 

Documents:
- Clique-droit/propriétés/Cible  
  - Paramêtres: *De base*
  - Rentrer le chemain d'accès à la racine \\WS19\DossiersUtilisateurs

Images:
- Clique-droit/propriétés/Cible   
  - Paramêtres: *Suivre les documents*  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/suivre_doc_gpo.png?raw=true)  

Pour le partage colléctif:
- AD
- User / Compte Utilisateurs / Delegue / ComptesUtilisateurs
- clique-droit / Propriété / Profil / chemin d'accès local 
    - Z:\\WS19\Partages\DSI

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/partage_co_gpo.png?raw=true)

Vérification du bon fonctionnement des GPO:
- Monter un W10
- Créer un user à rattaché au Domaine (check dans computer dans l'AD pour l'arrivée)
- Mettre un fichier dans un des dossiers Documents/Images/...
- Check dans l'AD s'il apparait bien dans l'arborescence de l'AD par DossierUser

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/win10_resultat.jpg?raw=true)

**Ressources:**
- [Entretien AD](https://www.active-directory.info/comment-bien-entretenir-son-annuaire-active-directory%E2%80%89/)


# MIGRATION ACTIVE DIRECTORY 2016 vers 219 (lvl ingénieur)

***Migration de version d'AD / Passer de 2016 à 2019***

**Ressources web**
- [Docs microsoft : Installer, mettre à niveau ou migrer vers Windows Server](https://docs.microsoft.com/fr-fr/windows-server/get-started/install-upgrade-migrate)
- [System-net : Migration Windows Server 2019 : Les étapes](https://www.system-net.fr/windows-server-2019/)
- [How to: Migration to Windows Server 2019 / 2016, including applications, profiles, shares and data](https://www.zinstall.com/how-to/how-to-server-2016-migration-software-for-windows-server-2003-2008-2012)
- [Migration d’une infra simple d’un serveur Active Directory 2012R2 vers 2016](https://laboiteajb.fr/migration-dune-infra-simple-dun-serveur-active-directory-2012r2-vers-2016/)

### Elements de compréhension et étapes à suivre

*Attention : Need monter de niveau fonctionnel 2012 vers 2016 (niveau fonctionnel toujours au plus haut pour migration)*

#### Migration simple

![*](https://raw.githubusercontent.com/RaspCric/In-girum-imus-nocte-et-consumimur-igni/images/IMG_20210831_172100_889.jpg)

**Existant**

| DC Principal | DC secondaire |
|:-:|:-:|
|Rôle FSMO| - |
|AD WServer 2016| AD WServer 2016|

**Préparation à la migration**

Faire venir une forêt 2019 dans une forêt 2016 = trois étapes exclusives au prinicpal (puisque possède les FSMO) pour préparation
  1. couper les réplications AD entre contollers (1 ligne de commande à passer) 
  2. préparer la forêt (1 ligne de commande à passer)
  3. prénarer le domaine (1 ligne de commande à passer)

**Première étape de migration**

- Préparation d'un WServer 2019 : NIC, antivirus etc.
- Insérer le WServer 2019 en controller de domaine secondaire dans la forêt 2016
  - Va se coller à la forêt 2016
  - Mode dit "mixte" (possible de rester ainsi en plusieus mois)
 
| DC Principal | DC secondaire | DC secondaire
|:-:|:-:|:-:|
|Rôle FSMO| - | - |
|AD WServer 2016| AD WServer 2016| AD WServer 2019|

**Seconde étape de migration**

- On migre les FSMO (les 5) doivent migrer vers DC secondaire 2019 
    - Via interface graphique

| DC secondaire | DC secondaire | DC principal
|:-:|:-:|:-:|
| - | - | Rôle FSMO |
|AD WServer 2016| AD WServer 2016| AD WServer 2019|

**Troisième étape de migration**

- Rétrogradation du second controller secondaires
    - Plus DNS ni AD
    - Redevient server simple

| DC secondaire | Server simple | DC principal
|:-:|:-:|:-:|
| - | - | Rôle FSMO |
|AD WServer 2016| AD WServer 2016| AD WServer 2019|

**Quatrième étape de migration**

- On crash/réinstalle le server simple en WServer2019
- On le fait venir en secondaire en 2019

| DC secondaire | DC secondaire | DC principal
|:-:|:-:|:-:|
| - | - | Rôle FSMO |
|AD WServer 2016| AD WServer 2019| AD WServer 2019|

- Bis repetita pour le premier controller

| DC secondaire | DC secondaire | DC principal
|:-:|:-:|:-:|
| - | - | Rôle FSMO |
|AD WServer 2019| AD WServer 2019| AD WServer 2019|

#### Migration de forêts

- Entreprise : acab.lan
- Achat ou fusion : nouveau nom, need nouvelle forêt (ex. anar.lan)
- Annunaire unique, identifiant unique à partir de plusieurs annuaires/identifiants

| Forêt 1 | Forêt 2 | > | Nouvelle forêt 1 | Nouvele forêt 2 |
|:-:|:-:|:-:|:-:|:-:|
| acab.lan | acab.lan | > | anar.lan | anar.lan |
| Controller 1 | Controller 2 | > | NvController 1 | NvController 2 |

![*](https://rdr-it.com/wp-content/uploads/2019/06/admt-00.png)

- Temps long : 
    - Mise en place DNS (Zone de stub, redirecteurs conditionnels) + relations d'approbation bi-directionnelle entre les deux domaines/forêts = permet la communication entre les deux forêts
    - Utilisation d'un [server ADMT](https://rdr-it.com/admt-outil-de-migration-de-domaine-active-directory/3/) pour la migration les objets de la source vers la cible
    - Installation de [Password Export Server](http://pbarth.fr/node/112) : utilitaire de migration des mots de passe
    - Une fois cela effectué on peut commencer à migrer
- On ne supprime les deux controllers de base qu'une fois l'ensemble de la migration effectuée


#### Migration via Azure AD

- Azure AD se base sur l'AD local
- Azure récupère et transpose directement dans Office365

![*](https://raw.githubusercontent.com/RaspCric/In-girum-imus-nocte-et-consumimur-igni/images/IMG_20210831_171914_624.jpg)

| DC Principal | DC secondaire | <- AZURE AD Source -> | Office 365 |
|:-:|:-:|:-:|:-:|
|Rôle FSMO| - | - | - |
|AD WServer 2016| AD WServer 2016| - | - |
|local 2019| local 2019 | - | - |

![*](https://docs.microsoft.com/fr-fr/azure/active-directory/hybrid/media/how-to-upgrade-previous-version/stagingserver1.png)

- UPN : obligé de passer par ligne de commande 

### ON VA MANIPER - MIGRATION WINDOWS SERVEUR 2016 A WINDOWS SERVEUR 2019

Sur Windows Servuer 2016  
Ouvrir l'invite de commande dans la VM et se rendre à la racine de C.  

On coupe les réplications  
> C:\>repadmin /options WS16 +disable_outbound_repl   

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_repadmin.png?raw=true)

Pour préparer l'AD 2016 à recevoir la fôret de 2019. 
On charge l'ISO de Windows Serveur 2019 dans le lecteur virtuel.  
On se met dans le répertoire support puis adprep.  
> D:\support\aprep>

On tape la commande:  
>adprep /forestprep

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_adprep.png?raw=true)
  
Toujours dans D:\support\adprep> , on met à jour le domaine:  
>adprep /domainprep  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/_mig_domain.png?raw=true)

**Ajouter un contrôleur AD 2019 dans notre AD 2016**  

Maintenant, on peut ajouter un contrôleur AD 2019 dans notre AD 2016.  
On réactive les répliques et on y touche plus. Pas besoin de les couper à nouveau, même si on reprends la migration des mois plus tard.  
Retour dans C:
>repadmin /options WS16 -disabled_outbound_repl

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_activerepl.png?raw=true)

On monte un Windows Serveur 2019.  
On désactive le firewall et on met l'adresse du controlleur de domaine 2016 en DNS primaire.  
On prends une petite sureté, on ping les machines entre elle.  

Ensuite, il faut ajouter le Windows Serveur 2019 dans le **domaine** bobdy.lan  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_mise_domaine.png?raw=true)

**Se reconnecter dans le Windows Serveur 2019 en compte bobdy\administrateur.**

Installer les rôle AD DS.

Promouvoir en Controlleur de Domaine.
Verifier qu'on soit bien dans le bon domaine.

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/promo_control.png?raw=true)

On passe au vérifications, pour être sûr que tout c'est bien passé.
  - Dans l'AD19, Carte Réseau: mettre l'AD 2019 en DNS primaire et l'AD 2016 en DNS Secondaire.
![]()
  - Dans l'AD19, Gestionnaire DNS: Verifier qu'il y ai bien: 
    - les zones, les records et les zones inversées.  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_gest_dns.png?raw=true)  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_gest_dn3.png?raw=true)
    - les serveurs de noms  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_gest_dns2.png?raw=true)  
    - les suffixes UPN  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_gest_dns4.png?raw=true)  
    - les sites and services  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_gest_dns5.png?raw=true)  
  - les réplications
  - les OU et sous-OU

  - Dans l'AD 2016, dans les paramêtre de carte réseau, mettre comme DNS secondaire l'AD 2019.

**MIGRATION DES ROLES FSMO DE l'AD2016 à L'AD2019**  

Le premier rôle a migré est caché. Il faut donc le faire apparaitre via une *petite commande*. Ouvrir l'invit de commande et se renre à la racine C:\
>regsvr32 schmmgmt.dll

On vas lancer une console vierge: 
|windows + R et **mmc**|
|:-:|
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/winR.png?raw=true)|

|Faire "Ajouter..fichables" puis ajouter le Schéma Active Directory|
|:-:|
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/fsmo_mmc.png?raw=true)|

|Clique-droit sur "Schéma Active Directory", Changer de contrôleur de domaine Active Directory|
|:-:|
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/fsmo_mmc2.png?raw=true)|

Clique-droit sur "Schéma Active Directory", Maitre d'Opérations, Cliquez sur Modifier:
|Clique-droit sur "Schéma Active Directory", Maitre d'Opérations| Cliquez sur Modifier|
|:-:|:-:|
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/fsmo_mmc3.png?raw=true)|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/fsmo_mmc4.png?raw=true)

**2ème ROLE**

Dans Domaines et Approbations Active Directory
Clique-droit, Changer de contrôleur de domaine Active Directory et promouvoir l'AD 2019
Clique droit, Maitre d'Opérations, Cliquez sur Modifier

**3 DERNIER ROLE**

Dans Utilisateurs et ordinateurs Active Directory
Clique-droit, Changer de contrôleur de domaine Active Directory et promouvoir l'AD 2019
Clique-droit sur notre nom de domaine, Maitre d'opérations:
  - RID : Modifier, OUI, oK
  - CDP: Modifier, OUI, ok
  - Infrastructure: Modifier, OUI, ok

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/fsmo_mmc5.png?raw=true)

**RETROGRADATION DE WINDOWS SERVEUR 2016**

Gestionnaire de Serveurs, Gérer, Supprimer des rôles et des fonctionnalités.
Il nous propose une méthode de rétrogradation à la décoche.

Décocher Service AD DS  
![](https://raw.githubusercontent.com/cromm24/Hello_World/main/AT2/AT2C1/AD/mig_retro_AD.png?raw=true)

Cocher "Procéder à la suppression"  
![](https://raw.githubusercontent.com/cromm24/Hello_World/main/AT2/AT2C1/AD/mig_retro_AD2.png?raw=true)

Cliquez sur Retrograder  
![](https://raw.githubusercontent.com/cromm24/Hello_World/main/AT2/AT2C1/AD/mig_retro_AD3.png?raw=true)

Enfin refaire supprimer les rôles et décocher les deux rôles et cette fois-ci il ne vas pas discuter.  
On va dans les paramêtres de carte réseau et on retire l'adresse IP du DNS du Windows Serveur 2016.  
![](https://raw.githubusercontent.com/cromm24/Hello_World/main/AT2/AT2C1/AD/mig_retro_AD4.png?raw=true)

**QUELQUES NETOYAGES SUR LE NOUVEAU CONTROLLEUR PRINCIPALE WINDOWS 2019**  

Gestionnaire DNS  
Clique-droit sur **bobdy.lan** et vérifier que dans les serveurs de noms, l'ancien serveur 2016 n'y soit plus et sinon supprimez le.  
Idem dans **bobdy.fr**   

Sites and Services Active Directory  
Supprimez le serveur WS16.  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/net_AD19.png?raw=true)  

Utilisateur et ordinateurs Active Directory  
Supprimez le serveur des computers.   

Gestionnaire DNS   
Supprime le record du Windows Serveur 2019  

|***Dernière opération, dans Domaines et approbations Active Directory, clique-droit, augmenté le niveau fonctionnel de la forêt. Sur une migration AD2016 à AD2019, il n'y en a pas besoin. Par contre de AD2008 à AD2012, deAD2012 à AD2012R2 et AD2012R2 à AD2016 il y a un niveau fonctionnel à monter.***|
|:-:|

### ON VA MANIPER - MIGRATION INTER-FORET

Pour supprimer une OU: *Affichage, fonctionnalités avancées, clique-droit sur propriétés l'OU désirée, supprimer, onglet sécurité, décoché la case.*  

**Préparation de la base pour l'AD19 source et cible:**
- Désactiver les firewalls des 2 Windows Serveur.  
- Sur la carte réseau du WS19CIBLE, on fixe l'IP: 192.168.20.53  
- Renommer le nom et mettre WS19CIBLE  
- On installe les rôles Services AD DS et rôles DNS  
- Promouvoir en contrôleur de domaine complétement indépendant: **paradise.lan**  
- Faire les réglages de bases classiques  
- Mettre la réplication à 15 minutes  
- Créer son subnet dans Sites and Services AD   
- Créer son domaine commercial dans les suffixes UPN en .fr   
- On prépare les OU en prévision de la prochaine migration.  
- Même si ca communique pas encore: Mettre sur les deux cartes réseaux, les deux DNS.   

**Contrôleur Source:**

*On va créer une zone de stub*
|||
|:-:|:-:|
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_stub.png?raw=true)|La zone de stub va permettre de joindre la deuxième forêt.|   
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_stub2.png?raw=true)|On ajoute notre domaine cible **paradise.lan**|  
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_stub3.png?raw=true)|L'adresse IP de notre controlleur cible: 192.168.20.53|  

Vérifier que la zone est bien tombé dans les Zones de recherches directes.  

**Contrôleur Cible:**

*Dans le gestionnaire DNS, on va créer un redirecteur conditionnel.*

|||
|:-:|:-:|
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_redir.png?raw=true)|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_redir2.png?raw=true)|

**Contrôleur Source:**

On va faire communiquer les deux forêts et les deux domaines.  

Domaines et approbations Active Directory  
Clique-droit sur la propriété, puis Approbations  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_approb.png?raw=true)  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_approb2.png?raw=true)  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_approb3.png?raw=true)   

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_approb4.png?raw=true)  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_approb5.png?raw=true)  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_approb6.png?raw=true)  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_approb7.png?raw=true)  

Si la zone d'approbation est passé c'est que la zone de stub et le redirecteur conditionnel sont bons.  

On va vérifier côté Contrôleur Cible:  
 - L'approbation est faite dans l'autre sens.   

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_approb8.png?raw=true)  

 - Sur le contrôleur cible, changer de domaine pour vérifier que les deux forêts communiquent.

|||
|:-:|:-:|
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_approb9.png?raw=true)|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_approb10.png?raw=true)|


**GESTION DES DROITS**

|Contrôleur Source|Contrôle Cible|
|:-:|:-:|
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_droit.png?raw=true)|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_droit2.png?raw=true)|


On vas permettre une délégation de contrôle sur le domaine cible, pour rajouter le compte administrateur du domaine source au OU du domaine cible.  

|||
|:-:|:-:|
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_droit3.png?raw=true)|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_droit4.png?raw=true)|

*Pour afficher l'onglet sécurité, il faut faire affichage, fonctionnalité avancée.*

On rajoute l'Administrateur en contrôle total du groupe sécurité. Idem pour le groupe Staff.  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_droit5.png?raw=true)  

On change de domaine, et on donne les mêmes droits au administrateurs sur les OU du domaine source.  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_droit6.png?raw=true)

**Controleur Source**  

Dans l'OU Builtin, il faut créer un groupe avec le nom netbios du domaine source avec 3 fois $ : BOBDY$$$  
Il sert à ADMT(logiciel qui permet la migration) de pouvoir migrer les objets.  
Et il ne faut pas mettre de membre ! (very important)  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_droit7.png?raw=true)  

Ouvrir la base de registre (la crée si elle n'existe pas)
- Clé de registre:
   - [HKEY_LOCAL_MACHINE\SYSTEM\Current\ControlSet\Control\Lsa] 
   - "TcpipClientSupport"=dword:00000001  

|||
|:-:|:-:|
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_droit8.png?raw=true)|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_droit9.png?raw=true)|  


**Contrôleur Source et Cible**

Gestion de Stragtégie de groupe.  
Il faut mettre une GPO en place, dans le domaine, Domain Controllers, Default Domain Controllers Policy  
Clique-droit Modifier  
Stratégie   
Paramêtre windows  
Paramêtre de sécurtié  
Stratégie Local  
Stratégie d'audit  
Auditer la gestion des comptes.  
Cocher les cases.  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_gpo.png?raw=true)

**Ligne de Commande**

Commande pour désactiver le SID filtering.  
 On commence par le contrôleur cible.   
> netdom trust (domaine cible) /domain:(domaine source) /quarantine:no /usero: (compte admin du controleur cible) /passwordo: (password du compte admin du controleur cible)  

donc

> netdom trust paradise.lan /domain:bobdy.lan /quarantine:no /usero:administrateur /passwordo:Dadfba16   

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_cmd.png?raw=true)

Même commande pour le contrôleur source. (évidemment on adapte la commande.)  

> netdom trust bobdy.lan /domain:paradise.lan /quarantine:no /usero:administrateur /passwordo:Dadfba16  

Commande pour activer le SID History   
On commence par le contrôleur source.   

> netdom trust (domain source) /domain:(domaine cible) /enablesidhistory:yes /usero:(compte source) /passwordo:(password source)  

donc    

> netdom trust bobdy.lan /domain:paradise.lan /enablesidhistory:yes /usero:administrateur /passwordo:Dadfba16  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_cmd2.png?raw=true)  

Même commande pour le contrôleur cible. (évidemment on adapte la commande.)  

> netdom trust paradise.lan /domain:bobdy.lan /enablesidhistory:yes /usero:administrateur /passwordo:Dadfba16  

**ADMT**

Cloner un windows serveur 2016 et l'appeller ADMT  
Désactiver le pare-feu et régler la carte réseau. (192.168.20.54/24 et DNS: contrôleur cible)  
On lui donne le nom ADMT et on le met dans le domaine cible (paradise.lan)  
On redemarre.  
Et on se log en nomdedomaine\administrateur (paradise\administrateur)  

AMDT fonctionnant avec une BDD, il faut lui installer un SQL express.  
[Lien SQL Server Express](https://www.microsoft.com/fr-fr/download/details.aspx?id=55994)  
[Lien ADMT](https://www.microsoft.com/fr-fr/download/details.aspx?id=56570)  
[Lien PES](https://www.microsoft.com/en-us/download/details.aspx?id=1838)

On installe SQL express. (Déclaré en instance et serveur ADMT)  
On install ADMT (ADMT\ADMT)  
Une fois ADMT installé on peut le lancer.  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admt_install.png?raw=true)  

On va généré sa clé de chiffrement pour la donner à PASSWORD EXPORT SERVER. C'est pour que PES et ADMT puissent migrer  
Invite de commande:    
> admt key /option:create /sourcedomain:(domainesource) /keyfile:(dans le répertoire que vous voulez)\admt_key /keypassword:(mdp que vous voulez)  

> admt key /option:create /sourcedomain:paradise.lan /keyfile:c:\admt_key /keypassword:Dadfba16  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admt_prep.png?raw=true)  

On install PES sur le contrôleur de domaine source.  
Récuperer le fichier admt_key.pes crée sur le contrôleur ADMT et le mettre dans le contrôleur source pour le charger lors de l'installation.  
Prendre le compte BOBDY\administrateur (domainesource\administrateur) pour se log a PES (dans la bonne pratique, il faudrait créer un compte PES exprès)  

Maintenant, il faut vérifier plusieurs points sur le contrôleur source:
- Clé de registre:
   - [HKEY_LOCAL_MACHINE\SYSTEM\Current\ControlSet\Control\Lsa] 
   - "AllowPasswordExport"=dword:00000001  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admt_prep2.png?raw=true)

- Services.msc
  - Il faut vérifier que le service de Password Export Serveur est bien en démarré en automatique et qu'il soit démarré.

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admt_prep3.png?raw=true)

**Migration des utilisateurs**

Vérifier que le service, PASSWORD EXPORT SERVICE, soit bien démarré.  
Clique droit, assistant de migrations des comptes d'utilisateurs  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig.png?raw=true)  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig2.png?raw=true)

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig3.png?raw=true)

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig4.png?raw=true)

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig5.png?raw=true)

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig8.png?raw=true)

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig9.png?raw=true)

Une fois les utilisateurs migrés, vérifier que les utilisateurs ont bien leurs nouveaux suffixes UPN.  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig6.png?raw=true)

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig7.png?raw=true)

**Migration des groupes**

C'est identique.  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte.png?raw=true)

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte1.png?raw=true)

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte2.png?raw=true)

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte3.png?raw=true)

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte4.png?raw=true)

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte5.png?raw=true)

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte6.png?raw=true)

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/admit_mig_compte7.png?raw=true)







**Ressources**
[AD](https://activedirectoryfaq.com/2015/10/active-directory-sid-filtering/)  

## AZURE AD CONNECT

Il s'installe sur un VM sur un AD local. Il faut le mettre sur un serveur dédié et il ne fait que ca. Il ne s'occupe que de la synchro.  
On crée un compte AD CONNECT, on le met administrateur général de MS365.

**Commande POWERSHELL**

Pour forcer la synchro:  
- Start-ADSyncSyncCycle -PolicyType Delta

Pour forcer le changement d'UPN:  
> set-MsolUserPrincipal -UserPrincipalName ancienUPN -NewUserPrincipalName nouveauUPN  

> set-MsolUserPrincipal -UserPrincipalName k.novoselic@cefim.eu -NewUserPrincipalName s.julie@cefim.eu