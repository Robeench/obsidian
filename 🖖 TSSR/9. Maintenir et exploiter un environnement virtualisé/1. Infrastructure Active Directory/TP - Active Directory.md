# Consignes
- [ ] Installer une machine Proxmox
- [ ] S√©parer mon r√©seau avec un WAN et un LAN
- [ ] Installer un PFSense
- [ ] Installer une machine Win10 client entreprise sur le LAN. Elle se connecte √† internet.
- [ ] Installer un serveur Windows 2019 avec les r√¥les AD + DNS + DHCP sur le LAN. Elle se connecte √† internet.
- [ ] Cr√©er deux sous OU : s√©curit√© et liste de diffusions
- [ ] Cr√©er 3 utilisateurs
- [ ] Cr√©er un groupe DSI et un groupe Service IT 
- [ ] Mettre Service IT d√©pendant du groupe DSI 
- [ ] Ajouter un utilisateur dans le groupe Service IT
- [ ] Me connecter avec un utilisateur sur la machine Windows 10

- [ ] Mise en place de GPO
- [ ] S√©curit√© NTFS (s√©curit√© sur les dossiers et les fichiers)

# Installation
## SRV_PFSENSE
- 1Go de RAM
- 1 CPU
- 8Go de SSD

Suite √† l'installation, suppression du disque avec l'ISO.
Ajout d'une carte r√©seau : 
- une pour le WAN = 192.168.1.107 /24
- une pour le LAN = 10.0.0.1 /24

## CLI-WIN10
- 2Go de RAM
- 1 CPU
- 30Go de SSD

Je mets en statique ses informations r√©seaux pour permettre de me connecter √† l'interface web de PFSense pour finaliser la configuration. 
IP = 10.0.0.2
Gateway = 10.0.0.1
DNS = 1.1.1.1
Et je d√©sactive l'IPv6

## SRV_WIN2019_01
- 8Go de RAM
- 1 CPU
- 50Go de SSD

Je mets en statique ses informations r√©seaux :
IP = 10.0.0.3
Gateway = 10.0.0.1
DNS = 1.1.1.1
Et je d√©sactive l'IPv6

Je modifie ensuite le nom de ma machine = SRV-AD

### Installer le r√¥le AD + DNS + DHCP
üóÇ Ajouter des r√¥les et des fonctionnalit√©s
	Installation bas√©e sur un r√¥le ou une fonctionnalit√©
		Cocher : [[serveur DHCP]] + [[serveur DNS]] + services AD DS
		Lancer l'installation des r√¥les
	üö©Promouvoir ce serveur en contr√¥leur de domaine
		Ajouter une nouvelle for√™t
		Nom de domaine racine = nitou.lan
		Options du contr√¥leur de domaine
			[[Serveur DNS]] + Catalogue global
			Mot de passe = L'informatique ?
		Nom NETBIOS, d√©termin√© automatiquement = nitou
		Cehmin d'acc√®s
			Chemins d'enregistrement de la base de donn√©es
			Bonne pratique : sauvegarde des logs sur une partition D:
	Lancer l'installation
	Reboot

Cr√©ation de l'AD qui cr√©e le sch√©ma, la for√™t et les FSMO. 
Je peux v√©rifier lors de ma connexion √† Windows que je me connecte bien √† un domaine, le nom doit s'afficher ainsi : 
![[Pasted image 20230307101256.png]]
Je ne peux plus me connecter en administrateur local, je me connecte obligatoirement en administrateur du domaine. 

### Configuration
#### DNS
Modification du DNS, j'indique sa propre adresse IP car il est d√©sormais [[serveur DNS]]. 

üóÇ Outils d'administration
	DNS
		V√©rification que mon domaine apparait bien en zone directe
		Cr√©ation de la zone de recherche invers√©e
			Clic-droit
				Nouvelle zone
					Zone principale
					Vers tous les serveurs DNS ex√©cut√©s sur des contr√¥leurs de domaine dans ce domaine
					Zone de recherche invers√©e IPv4
					ID r√©seau = 10.0.0
			Clic-droit sur nitou.lan
				Nouvel h√¥te (A ou AAAA)
					D√©finir l'adresse IP
					Cocher cr√©er un PTR associ√©
			Clic-droit SRV-AD
				Propri√©t√©s
					Redirecteurs
						Ajouter les DNS de FAI (permet au WAN de pointer vers le LAN)

#### AD
üóÇ Outils d'administration
	Utilisateurs et ordinateurs active directory
		On v√©rifie les diff√©rents √©l√©ments
		Sur nitou.lan
			Clic-droit
				Toutes les t√¢ches
					Maitre d'op√©rations
						Je v√©rifie que j'ai bien les 3 r√¥les FSMO
		Builtin
Assez peu utilis√© au quotidien
		Computer
OU d'arriv√©e des PCs et des serveurs dans l'AD
		Domain Controllers
AD secondaire
		Users
			Administrateur du domaine
Niveau le plus bas
Acc√®s domaine pour l'usage quotidien
			Administrateur du sch√©ma
Possibilit√© de modifier le sch√©ma
OP d'expertise et de migration
			Administrateur de l'entreprise
Acc√®s total √† toute la structure de l'AD

üóÇ Outils d'administration
	Sites et services active directory
		Default First Site Name
Site sur lequel j'ai mis le contr√¥leur de domaine principal
On retrouve les contr√¥leurs de domaine rattach√© √† ce site
		Inter-Site-Transports
			IP
				DEFAULTTIPSITELINK
					Clic-droit
						Propri√©t√©s
							Fixer la r√©plication toutes les 15 minutes
C'est le moteur de r√©plication entre les contr√¥leurs de domaines
		 Sites
			 Clic-droit
				 Ajouter un nouveau site : Marseille et Tours
				 Cr√©er ensuite le subnet du r√©seau de Marseille et de Tours
		Subnets
			Clic-droit
				Nouveau sous-r√©seau

üóÇ Outils d'administration
	Domaine et approbation active directory
		Clic-droit
			Propri√©t√©s
On peut simuler la cr√©ation de domaine ou de sous-domaine
			
üóÇ Outils d'administration
	Modification ADSI
Retranscription de l'AD c√¥t√© for√™t
C≈ìur de l'AD

#### DHCP
http://www.octetmalin.net/windows/tutoriels/windows-server-2012-dhcp-ajouter-et-configurer-une-nouvelle-etendue.php




# GPO ET TRANSFERTS DE FICHIER

# GPO
**Premi√®re GPO**  

Toujours faire ses GPO sur la derni√®res sous-OU.  
Outils / Gestion des strat√©gies de Groupes.  

Cr√©er une GPO
	Clique-droit / Propri√©t√©s sur la GPO qui vient d'√™tre cr√©er.
Script Powershell
	Mettre le script dans le dossier (en bas l'image), puis le charg√© dans le gestionnaire.
Cr√©ation de notre arborescence de fichier sur le lecteur C:
	C:\Partages\DSI\Service_IT

## Sur le dossier parent Dossiers Utilisateurs
Clique-droit sur le dossier Partages/Propri√©t√©s/Partage avanc√© puis cocher "Partager ce dossier"
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/partage_gpo.png?raw=true)  
Ne pas oublier l'autorisation partage sinon pas de partage
Clique-droit sur le dossier Partages/Propri√©t√©s/S√©curit√© puis coch√© "Partager ce dossier"
Cliquez sur "Convertir [...] sur cet objet" 
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/h%C3%A9ritage_gpo.png?raw=true)

Le truc qu'il faut mettre partout pour ne pas avoir d'emmerde
- Syst√®me: Acc√®s machine, **INDISPENSABLE**.
- Admins du domaine (OM\Admins du domaine)
- Utilisateurs Authentifier.
- On fait ajouter/Admin, chercher par nom et on trouve "admins du domaine".
- Ajouter/Avanc√©e/recherche/Utilisateurs authentifi√©s/Et affichage

## Sur le dossier enfant DSI
Ne pas laisser le ***CONTROLE TOTAL*** pour les utilisateurs car cela leur donne acc√®s √† l'onglet de s√©curit√© ce qui est une faille de s√©curit√© √©norme.

## Faire la m√™me proc√©dure pour le dossier enfant Service IT.
On vas s'occuper de l'arborescence des dossiers utilisateurs.
- On cr√©e le dossier √† la racine du disque:
  - C:\DossiersUtilisateurs
- On applique le partage sur ce dossier (comme vu pr√©cedemment).
- S√©curit√©:
  - On d√©sactive l'h√©ritage (comme vu pr√©c√©demment).
  - On active la s√©curit√© syst√®me, administrateur du domaine et utilisateurs authentifiers.
- Dans le dossier parent, on cr√©e un dossier enfant avec un le SAM de l'utilisateur (apendragon).  
  - On g√®re la s√©curit√©(comme vu pr√©c√©demment) mais on enl√®ve l'utilisateur authentifier et mettre l'user √† la place, avec les r√®gles qui vont bien.

## Quota
Sur C: Clique-droit/propri√©t√©s/onglet Quota: 
- Cocher Activer la gestion
-  Refuser de l'espace disque ...   

Si on rend pas l'utilisateur propri√©taire de son dossier, il n'auras pas son quota.
Pour faire de l'individuel, il faut clique-droit sur l'user pour g√©rer son espace disque.
Clique-droit sur le dossier/Propri√©t√©s/S√©curit√©/Avanc√©/Modifier/Choisir l'utilisateur.  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/proprio_dossier_user.png?raw=true)

## Dossiers des utilisateurs
Ouvrir l'√©diteur de Gestion des strat√©gies de groupes 
Bureau: 
- Clique-droit/propri√©t√©s/Cible  
  - Param√®tres: *De base*
  - Rentrer le chemin d'acc√®s √† la racine \\WS19\DossiersUtilisateurs

- Clique-droit/propri√©t√©s/Param√®tres
  - D√©coch√© *Accorder √† l'utilisateurs des droits exclusifs sur Bureau* (sinon les admins ne peuvent plus y acc√©der pour r√©gler des probl√®mes)  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/proprio_bureau_gpo2.png?raw=true)

Favoris:
- Clique-droit/propri√©t√©s/Cible  
  - Param√®tres: *De base*
  - Rentrer le chemin d'acc√®s √† la racine \\WS19\DossiersUtilisateurs 

Documents:
- Clique-droit/propri√©t√©s/Cible  
  - Param√®tres: *De base*
  - Rentrer le chemin d'acc√®s √† la racine \\WS19\DossiersUtilisateurs

Images:
- Clique-droit/propri√©t√©s/Cible   
  - Param√®tres: *Suivre les documents*  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/suivre_doc_gpo.png?raw=true)  

Pour le partage collectif:
- AD
- User / Compte Utilisateurs / Delegue / ComptesUtilisateurs
- clique-droit / Propri√©t√© / Profil / chemin d'acc√®s local 
    - Z:\\WS19\Partages\DSI
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/partage_co_gpo.png?raw=true)

V√©rification du bon fonctionnement des GPO:
- Monter un W10
- Cr√©er un user √† rattach√© au Domaine (check dans computer dans l'AD pour l'arriv√©e)
- Mettre un fichier dans un des dossiers Documents/Images/...
- Check dans l'AD s'il apparait bien dans l'arborescence de l'AD par DossierUser

Ressource
- [Entretien AD](https://www.active-directory.info/comment-bien-entretenir-son-annuaire-active-directory%E2%80%89/)

# MIGRATION ACTIVE DIRECTORY 2016 vers 219 (lvl ing√©nieur)

Migration de version d'AD / Passer de 2016 √† 2019

Ressources web
- [Docs microsoft : Installer, mettre √† niveau ou migrer vers Windows Server](https://docs.microsoft.com/fr-fr/windows-server/get-started/install-upgrade-migrate)
- [System-net : Migration Windows Server 2019 : Les √©tapes](https://www.system-net.fr/windows-server-2019/)
- [How to: Migration to Windows Server 2019 / 2016, including applications, profiles, shares and data](https://www.zinstall.com/how-to/how-to-server-2016-migration-software-for-windows-server-2003-2008-2012)
- [Migration d‚Äôune infra simple d‚Äôun serveur Active Directory 2012R2 vers 2016](https://laboiteajb.fr/migration-dune-infra-simple-dun-serveur-active-directory-2012r2-vers-2016/)

### Elements de compr√©hension et √©tapes √† suivre
*Attention : Need monter de niveau fonctionnel 2012 vers 2016 (niveau fonctionnel toujours au plus haut pour migration)*

#### Migration simple

![*](https://raw.githubusercontent.com/RaspCric/In-girum-imus-nocte-et-consumimur-igni/images/IMG_20210831_172100_889.jpg)

**Existant**

| DC Principal | DC secondaire |
|:-:|:-:|
|R√¥le FSMO| - |
|AD WServer 2016| AD WServer 2016|

**Pr√©paration √† la migration**

Faire venir une for√™t 2019 dans une for√™t 2016 = trois √©tapes exclusives au prinicpal (puisque poss√®de les FSMO) pour pr√©paration
  1. couper les r√©plications AD entre contollers (1 ligne de commande √† passer) 
  2. pr√©parer la for√™t (1 ligne de commande √† passer)
  3. pr√©narer le domaine (1 ligne de commande √† passer)

**Premi√®re √©tape de migration**

- Pr√©paration d'un WServer 2019 : NIC, antivirus etc.
- Ins√©rer le WServer 2019 en controller de domaine secondaire dans la for√™t 2016
  - Va se coller √† la for√™t 2016
  - Mode dit "mixte" (possible de rester ainsi en plusieus mois)
 
| DC Principal | DC secondaire | DC secondaire
|:-:|:-:|:-:|
|R√¥le FSMO| - | - |
|AD WServer 2016| AD WServer 2016| AD WServer 2019|

**Seconde √©tape de migration**

- On migre les FSMO (les 5) doivent migrer vers DC secondaire 2019 
    - Via interface graphique

| DC secondaire | DC secondaire | DC principal
|:-:|:-:|:-:|
| - | - | R√¥le FSMO |
|AD WServer 2016| AD WServer 2016| AD WServer 2019|

**Troisi√®me √©tape de migration**

- R√©trogradation du second controller secondaires
    - Plus DNS ni AD
    - Redevient server simple

| DC secondaire | Server simple | DC principal
|:-:|:-:|:-:|
| - | - | R√¥le FSMO |
|AD WServer 2016| AD WServer 2016| AD WServer 2019|

**Quatri√®me √©tape de migration**

- On crash/r√©installe le server simple en WServer2019
- On le fait venir en secondaire en 2019

| DC secondaire | DC secondaire | DC principal
|:-:|:-:|:-:|
| - | - | R√¥le FSMO |
|AD WServer 2016| AD WServer 2019| AD WServer 2019|

- Bis repetita pour le premier controller

| DC secondaire | DC secondaire | DC principal
|:-:|:-:|:-:|
| - | - | R√¥le FSMO |
|AD WServer 2019| AD WServer 2019| AD WServer 2019|

#### Migration de for√™ts

- Entreprise : acab.lan
- Achat ou fusion : nouveau nom, need nouvelle for√™t (ex. anar.lan)
- Annunaire unique, identifiant unique √† partir de plusieurs annuaires/identifiants

| For√™t 1 | For√™t 2 | > | Nouvelle for√™t 1 | Nouvele for√™t 2 |
|:-:|:-:|:-:|:-:|:-:|
| acab.lan | acab.lan | > | anar.lan | anar.lan |
| Controller 1 | Controller 2 | > | NvController 1 | NvController 2 |

![*](https://rdr-it.com/wp-content/uploads/2019/06/admt-00.png)

- Temps long : 
    - Mise en place DNS (Zone de stub, redirecteurs conditionnels) + relations d'approbation bi-directionnelle entre les deux domaines/for√™ts = permet la communication entre les deux for√™ts
    - Utilisation d'un [server ADMT](https://rdr-it.com/admt-outil-de-migration-de-domaine-active-directory/3/) pour la migration les objets de la source vers la cible
    - Installation de [Password Export Server](http://pbarth.fr/node/112) : utilitaire de migration des mots de passe
    - Une fois cela effectu√© on peut commencer √† migrer
- On ne supprime les deux controllers de base qu'une fois l'ensemble de la migration effectu√©e


#### Migration via Azure AD

- Azure AD se base sur l'AD local
- Azure r√©cup√®re et transpose directement dans Office365

![*](https://raw.githubusercontent.com/RaspCric/In-girum-imus-nocte-et-consumimur-igni/images/IMG_20210831_171914_624.jpg)

| DC Principal | DC secondaire | <- AZURE AD Source -> | Office 365 |
|:-:|:-:|:-:|:-:|
|R√¥le FSMO| - | - | - |
|AD WServer 2016| AD WServer 2016| - | - |
|local 2019| local 2019 | - | - |

![*](https://docs.microsoft.com/fr-fr/azure/active-directory/hybrid/media/how-to-upgrade-previous-version/stagingserver1.png)

- UPN : oblig√© de passer par ligne de commande 

### ON VA MANIPER - MIGRATION WINDOWS SERVEUR 2016 A WINDOWS SERVEUR 2019

Sur Windows Servuer 2016  
Ouvrir l'invite de commande dans la VM et se rendre √† la racine de C.  

On coupe les r√©plications  
> C:\>repadmin /options WS16 +disable_outbound_repl   

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_repadmin.png?raw=true)

Pour pr√©parer l'AD 2016 √† recevoir la f√¥ret de 2019. 
On charge l'ISO de Windows Serveur 2019 dans le lecteur virtuel.  
On se met dans le r√©pertoire support puis adprep.  
> D:\support\aprep>

On tape la commande:  
>adprep /forestprep

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_adprep.png?raw=true)
  
Toujours dans D:\support\adprep> , on met √† jour le domaine:  
>adprep /domainprep  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/_mig_domain.png?raw=true)

**Ajouter un contr√¥leur AD 2019 dans notre AD 2016**  

Maintenant, on peut ajouter un contr√¥leur AD 2019 dans notre AD 2016.  
On r√©active les r√©pliques et on y touche plus. Pas besoin de les couper √† nouveau, m√™me si on reprends la migration des mois plus tard.  
Retour dans C:
>repadmin /options WS16 -disabled_outbound_repl

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_activerepl.png?raw=true)

On monte un Windows Serveur 2019.  
On d√©sactive le firewall et on met l'adresse du controlleur de domaine 2016 en DNS primaire.  
On prends une petite suret√©, on ping les machines entre elle.  

Ensuite, il faut ajouter le Windows Serveur 2019 dans le **domaine** bobdy.lan  

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_mise_domaine.png?raw=true)

**Se reconnecter dans le Windows Serveur 2019 en compte bobdy\administrateur.**

Installer les r√¥le AD DS.

Promouvoir en Controlleur de Domaine.
Verifier qu'on soit bien dans le bon domaine.

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/promo_control.png?raw=true)

On passe au v√©rifications, pour √™tre s√ªr que tout c'est bien pass√©.
  - Dans l'AD19, Carte R√©seau: mettre l'AD 2019 en DNS primaire et l'AD 2016 en DNS Secondaire.
![]()
  - Dans l'AD19, Gestionnaire DNS: Verifier qu'il y ai bien: 
    - les zones, les records et les zones invers√©es.  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_gest_dns.png?raw=true)  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_gest_dn3.png?raw=true)
    - les serveurs de noms  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_gest_dns2.png?raw=true)  
    - les suffixes UPN  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_gest_dns4.png?raw=true)  
    - les sites and services  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_gest_dns5.png?raw=true)  
  - les r√©plications
  - les OU et sous-OU

  - Dans l'AD 2016, dans les param√™tre de carte r√©seau, mettre comme DNS secondaire l'AD 2019.

**MIGRATION DES ROLES FSMO DE l'AD2016 √† L'AD2019**  

Le premier r√¥le a migr√© est cach√©. Il faut donc le faire apparaitre via une *petite commande*. Ouvrir l'invit de commande et se renre √† la racine C:\
>regsvr32 schmmgmt.dll

On vas lancer une console vierge: 
|windows + R et **mmc**|
|:-:|
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/winR.png?raw=true)|

|Faire "Ajouter..fichables" puis ajouter le Sch√©ma Active Directory|
|:-:|
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/fsmo_mmc.png?raw=true)|

|Clique-droit sur "Sch√©ma Active Directory", Changer de contr√¥leur de domaine Active Directory|
|:-:|
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/fsmo_mmc2.png?raw=true)|

Clique-droit sur "Sch√©ma Active Directory", Maitre d'Op√©rations, Cliquez sur Modifier:
|Clique-droit sur "Sch√©ma Active Directory", Maitre d'Op√©rations| Cliquez sur Modifier|
|:-:|:-:|
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/fsmo_mmc3.png?raw=true)|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/fsmo_mmc4.png?raw=true)

**2√®me ROLE**

Dans Domaines et Approbations Active Directory
Clique-droit, Changer de contr√¥leur de domaine Active Directory et promouvoir l'AD 2019
Clique droit, Maitre d'Op√©rations, Cliquez sur Modifier

**3 DERNIER ROLE**

Dans Utilisateurs et ordinateurs Active Directory
Clique-droit, Changer de contr√¥leur de domaine Active Directory et promouvoir l'AD 2019
Clique-droit sur notre nom de domaine, Maitre d'op√©rations:
  - RID : Modifier, OUI, oK
  - CDP: Modifier, OUI, ok
  - Infrastructure: Modifier, OUI, ok

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/fsmo_mmc5.png?raw=true)

**RETROGRADATION DE WINDOWS SERVEUR 2016**

Gestionnaire de Serveurs, G√©rer, Supprimer des r√¥les et des fonctionnalit√©s.
Il nous propose une m√©thode de r√©trogradation √† la d√©coche.

D√©cocher Service AD DS  
![](https://raw.githubusercontent.com/cromm24/Hello_World/main/AT2/AT2C1/AD/mig_retro_AD.png?raw=true)

Cocher "Proc√©der √† la suppression"  
![](https://raw.githubusercontent.com/cromm24/Hello_World/main/AT2/AT2C1/AD/mig_retro_AD2.png?raw=true)

Cliquez sur Retrograder  
![](https://raw.githubusercontent.com/cromm24/Hello_World/main/AT2/AT2C1/AD/mig_retro_AD3.png?raw=true)

Enfin refaire supprimer les r√¥les et d√©cocher les deux r√¥les et cette fois-ci il ne vas pas discuter.  
On va dans les param√™tres de carte r√©seau et on retire l'adresse IP du DNS du Windows Serveur 2016.  
![](https://raw.githubusercontent.com/cromm24/Hello_World/main/AT2/AT2C1/AD/mig_retro_AD4.png?raw=true)

**QUELQUES NETOYAGES SUR LE NOUVEAU CONTROLLEUR PRINCIPALE WINDOWS 2019**  

Gestionnaire DNS  
Clique-droit sur **bobdy.lan** et v√©rifier que dans les serveurs de noms, l'ancien serveur 2016 n'y soit plus et sinon supprimez le.  
Idem dans **bobdy.fr**   

Sites and Services Active Directory  
Supprimez le serveur WS16.  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/net_AD19.png?raw=true)  

Utilisateur et ordinateurs Active Directory  
Supprimez le serveur des computers.   

Gestionnaire DNS   
Supprime le record du Windows Serveur 2019  

|***Derni√®re op√©ration, dans Domaines et approbations Active Directory, clique-droit, augment√© le niveau fonctionnel de la for√™t. Sur une migration AD2016 √† AD2019, il n'y en a pas besoin. Par contre de AD2008 √† AD2012, deAD2012 √† AD2012R2 et AD2012R2 √† AD2016 il y a un niveau fonctionnel √† monter.***|
|:-:|

### ON VA MANIPER - MIGRATION INTER-FORET

Pour supprimer une OU: *Affichage, fonctionnalit√©s avanc√©es, clique-droit sur propri√©t√©s l'OU d√©sir√©e, supprimer, onglet s√©curit√©, d√©coch√© la case.*  

**Pr√©paration de la base pour l'AD19 source et cible:**
- D√©sactiver les firewalls des 2 Windows Serveur.  
- Sur la carte r√©seau du WS19CIBLE, on fixe l'IP: 192.168.20.53  
- Renommer le nom et mettre WS19CIBLE  
- On installe les r√¥les Services AD DS et r√¥les DNS  
- Promouvoir en contr√¥leur de domaine compl√©tement ind√©pendant: **paradise.lan**  
- Faire les r√©glages de bases classiques  
- Mettre la r√©plication √† 15 minutes  
- Cr√©er son subnet dans Sites and Services AD   
- Cr√©er son domaine commercial dans les suffixes UPN en .fr   
- On pr√©pare les OU en pr√©vision de la prochaine migration.  
- M√™me si ca communique pas encore: Mettre sur les deux cartes r√©seaux, les deux DNS.   

**Contr√¥leur Source:**

*On va cr√©er une zone de stub*

|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_stub.png?raw=true)|La zone de stub va permettre de joindre la deuxi√®me for√™t.|   
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_stub2.png?raw=true)|On ajoute notre domaine cible **paradise.lan**|  
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_stub3.png?raw=true)|L'adresse IP de notre controlleur cible: 192.168.20.53|  

V√©rifier que la zone est bien tomb√© dans les Zones de recherches directes.  

**Contr√¥leur Cible:**

*Dans le gestionnaire DNS, on va cr√©er un redirecteur conditionnel.*

**Contr√¥leur Source:**

On va faire communiquer les deux for√™ts et les deux domaines.  

Domaines et approbations Active Directory  
Clique-droit sur la propri√©t√©, puis Approbations  

Si la zone d'approbation est pass√© c'est que la zone de stub et le redirecteur conditionnel sont bons.  

On va v√©rifier c√¥t√© Contr√¥leur Cible:  
 - L'approbation est faite dans l'autre sens.   

![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_approb8.png?raw=true)  

 - Sur le contr√¥leur cible, changer de domaine pour v√©rifier que les deux for√™ts communiquent.

**GESTION DES DROITS**

|Contr√¥leur Source|Contr√¥le Cible|
|:-:|:-:|
|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_droit.png?raw=true)|![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_droit2.png?raw=true)|


On vas permettre une d√©l√©gation de contr√¥le sur le domaine cible, pour rajouter le compte administrateur du domaine source au OU du domaine cible.  


*Pour afficher l'onglet s√©curit√©, il faut faire affichage, fonctionnalit√© avanc√©e.*

On rajoute l'Administrateur en contr√¥le total du groupe s√©curit√©. Idem pour le groupe Staff.  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_droit5.png?raw=true)  

On change de domaine, et on donne les m√™mes droits au administrateurs sur les OU du domaine source.  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_droit6.png?raw=true)

**Contr√¥leur Source**  

Dans l'OU Builtin, il faut cr√©er un groupe avec le nom netbios du domaine source avec 3 fois $ : 
`NITOU$$$`
Il sert √† ADMT(logiciel qui permet la migration) de pouvoir migrer les objets.  
Et il ne faut pas mettre de membre ! (very important)  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/foret_droit7.png?raw=true)  

Ouvrir la base de registre (la cr√©e si elle n'existe pas)
- Cl√© de registre:
   - [HKEY_LOCAL_MACHINE\SYSTEM\Current\ControlSet\Control\Lsa] 
   - "TcpipClientSupport"=dword:00000001  

Contr√¥leur Source et Cible

Gestion de Stragt√©gie de groupe.  
Il faut mettre une GPO en place, dans le domaine, Domain Controllers, Default Domain Controllers Policy  
Clique-droit Modifier  
Strat√©gie   
Param√™tre windows  
Param√™tre de s√©curti√©  
Strat√©gie Local  
Strat√©gie d'audit  
Auditer la gestion des comptes.  
Cocher les cases.  
![](https://github.com/cromm24/Hello_World/blob/main/AT2/AT2C1/AD/mig_gpo.png?raw=true)

Ligne de Commande

Commande pour d√©sactiver le SID filtering.  
 On commence par le contr√¥leur cible.   
> netdom trust (domaine cible) /domain:(domaine source) /quarantine:no /usero: (compte admin du controleur cible) /passwordo: (password du compte admin du controleur cible)  

donc

> netdom trust paradise.lan /domain:bobdy.lan /quarantine:no /usero:administrateur /passwordo:Dadfba16   


M√™me commande pour le contr√¥leur source. (√©videmment on adapte la commande.)  

> netdom trust bobdy.lan /domain:paradise.lan /quarantine:no /usero:administrateur /passwordo:Dadfba16  

Commande pour activer le SID History   
On commence par le contr√¥leur source.   

> netdom trust (domain source) /domain:(domaine cible) /enablesidhistory:yes /usero:(compte source) /passwordo:(password source)  

donc    

> netdom trust bobdy.lan /domain:paradise.lan /enablesidhistory:yes /usero:administrateur /passwordo:Dadfba16  


M√™me commande pour le contr√¥leur cible. (√©videmment on adapte la commande.)  

> netdom trust paradise.lan /domain:bobdy.lan /enablesidhistory:yes /usero:administrateur /passwordo:Dadfba16  

**ADMT**

Cloner un windows serveur 2016 et l'appeller ADMT  
D√©sactiver le pare-feu et r√©gler la carte r√©seau. (192.168.20.54/24 et DNS: contr√¥leur cible)  
On lui donne le nom ADMT et on le met dans le domaine cible (paradise.lan)  
On redemarre.  
Et on se log en nomdedomaine\administrateur (paradise\administrateur)  

AMDT fonctionnant avec une BDD, il faut lui installer un SQL express.  
[Lien SQL Server Express](https://www.microsoft.com/fr-fr/download/details.aspx?id=55994)  
[Lien ADMT](https://www.microsoft.com/fr-fr/download/details.aspx?id=56570)  
[Lien PES](https://www.microsoft.com/en-us/download/details.aspx?id=1838)

On installe SQL express. (D√©clar√© en instance et serveur ADMT)  
On install ADMT (ADMT\ADMT)  
Une fois ADMT install√© on peut le lancer.  
 

On va g√©n√©r√© sa cl√© de chiffrement pour la donner √† PASSWORD EXPORT SERVER. C'est pour que PES et ADMT puissent migrer  
Invite de commande:    
> admt key /option:create /sourcedomain:(domainesource) /keyfile:(dans le r√©pertoire que vous voulez)\admt_key /keypassword:(mdp que vous voulez)  

> admt key /option:create /sourcedomain:paradise.lan /keyfile:c:\admt_key /keypassword:Dadfba16  


On install PES sur le contr√¥leur de domaine source.  
R√©cuperer le fichier admt_key.pes cr√©e sur le contr√¥leur ADMT et le mettre dans le contr√¥leur source pour le charger lors de l'installation.  
Prendre le compte BOBDY\administrateur (domainesource\administrateur) pour se log a PES (dans la bonne pratique, il faudrait cr√©er un compte PES expr√®s)  

Maintenant, il faut v√©rifier plusieurs points sur le contr√¥leur source:
- Cl√© de registre:
   - [HKEY_LOCAL_MACHINE\SYSTEM\Current\ControlSet\Control\Lsa] 
   - "AllowPasswordExport"=dword:00000001  


- Services.msc
  - Il faut v√©rifier que le service de Password Export Serveur est bien en d√©marr√© en automatique et qu'il soit d√©marr√©.


Migration des utilisateurs

V√©rifier que le service, PASSWORD EXPORT SERVICE, soit bien d√©marr√©.  
Clique droit, assistant de migrations des comptes d'utilisateurs  



Une fois les utilisateurs migr√©s, v√©rifier que les utilisateurs ont bien leurs nouveaux suffixes UPN.  


Migration des groupes

C'est identique. 


[AD](https://activedirectoryfaq.com/2015/10/active-directory-sid-filtering/)  

## AZURE AD CONNECT
Il s'installe sur un VM sur un AD local. Il faut le mettre sur un serveur d√©di√© et il ne fait que ca. Il ne s'occupe que de la synchro.  
On cr√©e un compte AD CONNECT, on le met administrateur g√©n√©ral de MS365.

Commande POWERSHELL

Pour forcer la synchro:  
- Start-ADSyncSyncCycle -PolicyType Delta

Pour forcer le changement d'UPN:  
> set-MsolUserPrincipal -UserPrincipalName ancienUPN -NewUserPrincipalName nouveauUPN  

> set-MsolUserPrincipal -UserPrincipalName k.novoselic@cefim.eu -NewUserPrincipalName s.julie@cefim.eu