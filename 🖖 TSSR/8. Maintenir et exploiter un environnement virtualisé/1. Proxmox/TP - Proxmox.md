- [x] Monter deux serveurs PROMOX (1 processeurs, 4 cœurs + 4Go de RAM + 100 Go ou plus de SSD)
- [x] Mettre en cluster  les serveurs Proxmox
- [x] Créer un template de machine virtuelle
- [x] Créer une machine a l'aide de ce template sur chaque nœud
- [x] Migrer chaque machine sur l'autre nœud
- [x] Cloner une machine a chaud et la migrer ensuite
- [x] Créer un partage externe SMB sur Proxmox
- [x] Sauvegarder une machine sur ce partage
- [x] Détruisez la machine sauvegardé et la réinstaller via le backup externe
- [x] Configurez les notifications mail des backup et tester l'envoi de mail
- [x] Ajout d'un disque supplémentaire de 30Go sur chaque nœud (redémarrer le nœud)
- [x] Ajout d'une seconde interface réseau sur chaque nœud. Configurer ces secondes interfaces (vmbr1) sur le même réseau.
- [x] Sur chaque nœud, installer Ceph (via le menu dans l'arborescence)
- [x] Configurer le/les managers puis créations des OSD sur chaque nœud
- [x] Création des Pools de stockage Ceph
- [x] Tester les migrations à chaud
- [x] Configurer HA
- [x] Arrêter PVE1 et voyez la migration à chaud de notre VM sur PVE2 automatiquement
- [x] Ajout d'un PVE3 au cluster

[Tutos-infos.fr - Proxmox](https://tutos-info.fr/index.php/proxmox/) 

# Installation des serveurs proxmox

## pve_1
- [ ] Bridge
- [ ] 1 processeur, 4 cœurs
- [ ] 4Go de RAM
- [ ] 30 Go de SSD

https://192.168.1.107:8006/

![[Pasted image 20230207112931.png]]

## pve_2
- [ ] Bridge
- [ ] 1 processeur, 4 cœurs
- [ ] 4Go de RAM
- [ ] 30 Go de SSD

https://192.168.1.108:8006/

![[Pasted image 20230207114216.png]]

## pve_3
- [ ] Bridge
- [ ] 1 processeur, 4 cœurs
- [ ] 4Go de RAM
- [ ] 30 Go de SSD

https://192.168.1.109:8006/

# Mise en place du cluster proxmox

[Partie 1 - Réaliser un cluster proxmox](https://www.youtube.com/watch?v=Y-n73ciSsZw)
[Partie 2 - Mise en place d'un cluster proxmox](https://www.youtube.com/watch?v=iBnaSNKGnZ4)

![[Pasted image 20230207123017.png]]

## Template de la VM 101
[Créer sa première VM sous Proxmox](https://www.it-connect.fr/comment-installer-proxmox-ve-7-0-et-creer-sa-premiere-vm/#V_Creer_une_machine_virtuelle_sous_Proxmox)
[Proxmox - Création d'un template de VM Debian 11](https://www.youtube.com/watch?v=xfOKS853aXI)

![[Pasted image 20230207220851.png]]

Je crée ma VM debian101
	- je la transforme en template debian-template101
		- je crée un clone debian100
			- je migre debian100 vers pve2
				- je transforme debian100 en debian-template100

## Partage SMB
SMB est un protocole de partage de fichier

```
apt-get install samba
systemctl enable --now smbd

```

https://openclassrooms.com/fr/courses/2356316-montez-un-serveur-de-fichiers-sous-linux/5173636-partagez-vos-fichiers-sur-un-reseau-heterogene-avec-samba

https://www.youtube.com/watch?v=wrg6JZ11cB0

## Configurer les interfaces réseaux
vmbr1 = interface avec réseau privé, dédié à la communication entre les noeuds

https://www.youtube.com/watch?v=iRE32sTI40A&t=1s
[Partie 4 - Mise en place de CEPH dans un cluster Proxmox](https://www.youtube.com/watch?v=OcqarjbubEM)

## Ceph
Ceph est une plateforme libre de stockage distribué. 
C'est à dire qu'elle permet d'utiliser les disques de plusieurs hôtes pour réaliser du stockage distribué., permettant par exemple d'effectuer des migrations de VM à chaud, ou d'éviter les pannes étant donné qu'il n'y aura pas de SPOF (Single Point Of Failure)

- Un nœud aura le rôle de manager
- Un nœud aura le rôle de moniteur, il faut au minimum 3 nœuds pour de la haute disponibilité. Ce sont eux qui ont pour rôle de surveiller le cluster.
- Un nœud ou plusieurs serviront à héberger les disques OSD, bien que le manager ou le moniteur peuvent tout aussi bien héberger. 
https://www.proxmox.com/en/training/video-tutorials/item/install-ceph-server-on-proxmox-ve

Documentation ceph serveur : https://pve.proxmox.com/wiki/Ceph_Server

# ajout disque virtuel
https://docs.vmware.com/en/VMware-Fusion/13/com.vmware.fusion.using.doc/GUID-4BE3F3B7-9579-4C30-B35E-5BC41267CDFD.html

# Erreur à l'installation de Ceph

## Failure running script /usr/share/proxmox-ve/pve-apt-hook

``` bash
#Check and make note of your kernel
uname -a  
  
#remove enterprise repo
mv /etc/apt/sources.list.d/pve-enterprise.list /root/  

#add no-subscription repo  
echo "deb [http://download.proxmox.com/debian/pve](http://download.proxmox.com/debian/pve) stretch pve-no-subscription" > /etc/apt/sources.list.d/pve-no-sub.list  
  
#do update, upgrade & dist-upgrade  
apt-get update  
apt-get upgrade  
apt-get dist-upgrade  
  
#make sure you see latest kernel ..uname -a (if you see new version like below or greater, its updated)  
uname -a  

#new output Linux air **4.15.18-7-pve** #1 SMP PVE 4.15.18-27 (Wed, 10 Oct 2018 10:50:11 +0200) x86_64 GNU/Linux  
  
#now reboot and got for ceph installation , it would got fine.  
pveceph install
```

## Suppression d'un nœud de cluster

``` bash
# Arrêt des services du cluster et de la synchronisation
systemctl stop pve-cluster corosync

# Forcer le mode local (ignore corosync.conf, force quorum) du Proxmox Cluster File System
pmxcfs -l

# Ensuite, suppression des données du dossier corosync
rm -r /etc/corosync/*

# Suppression du fichier corosync.conf contenant la configuration du cluster
rm /etc/pve/corosync.conf

# Stopper le processus pmxcfs
killall pmxcfs

# Démarrage du service "pve-cluster"
systemctl start pve-cluster
```

"pmx02" et "pmx03" n’apparaîtront plus dans le nœud "pmx01".

```bash
cd /etc/pve/nodes
ls
rm -rf pmx02 pmx03
```

"pmx01" est désormais de nouveau indépendant du cluster.
Mais par contre, "pmx01" apparaît encore dans le cluster composé de "pmx02" et "pmx03" avec une croix rouge qui indique qu'il est indisponible.
Donc pour le supprimer définitivement. Il faudra taper ces deux commandes sur n'importe quel nœud du cluster car le tout est synchronisé.

```bash
pvecm delnode pmx01
rm -rf /etc/pve/nodes/pmx01
```

## Error rados-connect failed - No such file or directory (500)

vérifier ping entre chaque nœud du cluster via le réseau dédié Ceph
vérifier ping 1.1
